---
name: sdd-document-management
description: SDDドキュメントのメンテナンス・整理を行うスキル。ドキュメント間の整合性チェック、実装との同期確認、完了タスクのアーカイブ、肥大化ファイルの最適化を提供します。すべての操作でユーザー承認を必須とします。
version: "1.0.0"
---

# SDDドキュメント管理スキル

SDDワークフローで作成されたドキュメントのメンテナンス・整理を行い、ドキュメントの品質と一貫性を維持します。

## 概要

開発が進むにつれて発生する以下の問題を解決します：

| 問題 | 解決機能 |
|------|----------|
| ドキュメント間の仕様矛盾 | 整合性チェック |
| 実装とドキュメントの乖離 | 実装同期チェック |
| 完了済みタスクの蓄積 | アーカイブ |
| ファイルの肥大化 | ファイル最適化 |

### スキル構成

```text
sdd-document-management
├── 1. 整合性チェック (consistency-check)
│   - requirements ↔ design ↔ tasks 間の矛盾検出
│   - 変更履歴に基づく差分追跡
│   - 矛盾箇所のレポート出力
│
├── 2. 実装同期チェック (sync-check)
│   - 実装コードとドキュメントの乖離検出
│   - API定義 vs 実装、DB設計 vs スキーマ等
│   - 更新が必要な箇所のリストアップ
│
├── 3. アーカイブ (archive)
│   - 完了済みタスク(DONE)のアーカイブ移動
│   - 古い決定事項のアーカイブ
│   - アーカイブディレクトリ構造の管理
│
└── 4. ファイル最適化 (optimize)
    - 肥大化ファイルの分割提案
    - 重複内容の統合提案
    - 目次・インデックスの再生成
```

### 共通原則

**すべての操作でユーザー承認を必須とする**

```text
チェック実行 → レポート出力 → ★ ユーザー承認 ★ → 修正/アーカイブ実行
```

## このスキルを使用する場面

### 定期メンテナンス
- 開発フェーズの区切りでドキュメント整理を行いたい場合
- リリース前にドキュメントの品質を確認したい場合

### 問題検知時
- ドキュメント間に矛盾を発見した場合
- 実装とドキュメントの不一致に気づいた場合
- ファイルが大きくなりすぎて管理が難しい場合

### タスク整理時
- 完了済みタスクが蓄積してindex.mdが見づらくなった場合
- 過去の決定事項を整理したい場合

---

## 機能1: 整合性チェック (consistency-check)

requirements、design、tasks間の矛盾や不整合を検出します。

### チェック観点

#### 1. 要件→設計の整合性

| チェック項目 | 内容 |
|-------------|------|
| 要件カバレッジ | すべてのREQ-XXXに対応する設計要素があるか |
| 過剰設計 | 要件にない機能が設計に含まれていないか |
| 用語の一貫性 | 同じ概念に異なる用語が使われていないか |

#### 2. 設計→タスクの整合性

| チェック項目 | 内容 |
|-------------|------|
| 設計カバレッジ | すべての設計要素に対応するタスクがあるか |
| タスク過不足 | 設計にない実装がタスクに含まれていないか |
| 参照の正確性 | タスクが参照するコンポーネント/APIは定義されているか |

#### 3. クロスリファレンス

| チェック項目 | 内容 |
|-------------|------|
| ID参照 | REQ-XXX、DEC-XXX等の参照が有効か |
| ファイル参照 | 参照先ファイルが存在するか |
| ステータス整合 | 依存タスクのステータスが矛盾していないか |

### 実行手順

```text
1. docs/requirements/ のすべてのREQ-XXX、US-XXXをリストアップ
2. docs/design/ の設計要素と要件の対応を確認
3. docs/tasks/ のタスクと設計の対応を確認
4. 矛盾・不整合をレポートにまとめる
5. ★ ユーザーに提示し承認を得る ★
6. 承認された修正を実行
```

### レポート形式

```markdown
# 整合性チェックレポート

## 実行日時
[YYYY-MM-DD HH:MM]

## サマリー

| カテゴリ | 件数 |
|---------|------|
| 要件カバレッジ不足 | X件 |
| 過剰設計 | X件 |
| 参照エラー | X件 |
| 用語不一致 | X件 |

## 詳細

### 要件カバレッジ不足

| 要件ID | 要件内容 | 状態 |
|--------|---------|------|
| REQ-XXX | [要件の内容] | 設計なし |

#### 推奨アクション
- [ ] docs/design/に設計を追加
- [ ] 要件を削除（不要な場合）

### 過剰設計

| 設計要素 | ファイル | 状態 |
|---------|---------|------|
| [コンポーネント名] | docs/design/components/xxx.md | 対応要件なし |

#### 推奨アクション
- [ ] docs/requirements/に要件を追加
- [ ] 設計を削除（不要な場合）

### 参照エラー

| 参照元 | 参照ID | 状態 |
|--------|-------|------|
| docs/tasks/phase-1/TASK-001.md | REQ-999 | 存在しない |

#### 推奨アクション
- [ ] 参照IDを修正
- [ ] 参照先を作成

### 用語不一致

| 用語A | 使用箇所A | 用語B | 使用箇所B |
|-------|----------|-------|----------|
| ユーザー | docs/requirements/stories/US-001.md | 利用者 | docs/design/components/auth.md |

#### 推奨アクション
- [ ] 用語を統一（どちらかに揃える）
```

### ユーザー承認フロー

```text
整合性チェックが完了しました。

【検出された問題】
- 要件カバレッジ不足: X件
- 過剰設計: X件
- 参照エラー: X件
- 用語不一致: X件

詳細レポートを確認し、以下の対応を選択してください：

A) すべての推奨アクションを実行
B) 問題ごとに個別に対応を選択
C) 今回は修正せずレポートのみ保存
```

---

## 機能2: 実装同期チェック (sync-check)

実装コードとドキュメントの乖離を検出します。

### チェック観点

#### 1. API同期

| チェック項目 | 比較対象 |
|-------------|---------|
| エンドポイント | docs/design/api/*.md vs 実装コード |
| リクエスト/レスポンス | ドキュメント定義 vs 実際の型定義 |
| HTTPメソッド | ドキュメント vs ルーティング |

#### 2. データベース同期

| チェック項目 | 比較対象 |
|-------------|---------|
| テーブル定義 | docs/design/database/*.md vs マイグレーション/スキーマ |
| カラム定義 | ドキュメント vs 実際のスキーマ |
| リレーション | ドキュメント vs 実際の外部キー |

#### 3. コンポーネント同期

| チェック項目 | 比較対象 |
|-------------|---------|
| インターフェース | docs/design/components/*.md vs 実装 |
| 公開メソッド | ドキュメント vs 実際のエクスポート |
| 依存関係 | ドキュメント vs import文 |

### 実行手順

```text
1. docs/design/api/ のAPI定義を抽出
2. 実装コードからルーティング・コントローラーを検出
3. 定義と実装を比較し乖離を検出
4. 同様にDB、コンポーネントもチェック
5. 乖離レポートを作成
6. ★ ユーザーに提示し承認を得る ★
7. 承認された更新を実行
```

### 乖離の分類

| 分類 | 説明 | 推奨アクション |
|-----|------|---------------|
| ドキュメント古い | 実装が先に変更された | ドキュメントを更新 |
| 実装漏れ | ドキュメントにあるが実装がない | 実装を追加 or ドキュメントを削除 |
| 未文書化 | 実装にあるがドキュメントがない | ドキュメントを追加 or 実装を削除 |

### レポート形式

```markdown
# 実装同期チェックレポート

## 実行日時
[YYYY-MM-DD HH:MM]

## サマリー

| カテゴリ | 同期 | 乖離 |
|---------|-----|------|
| API | X件 | X件 |
| データベース | X件 | X件 |
| コンポーネント | X件 | X件 |

## API乖離詳細

### ドキュメントが古い

| エンドポイント | ドキュメント | 実装 | 差異 |
|---------------|-------------|------|-----|
| POST /api/users | docs/design/api/users.md | src/routes/users.ts | レスポンスフィールド追加 |

#### 詳細
- ドキュメント定義:
  ```json
  { "id": "string", "name": "string" }
  ```
- 実装:
  ```json
  { "id": "string", "name": "string", "createdAt": "string" }
  ```

#### 推奨アクション
- [ ] docs/design/api/users.mdを更新してcreatedAtを追加

### 未文書化の実装

| 実装 | ファイル | 説明 |
|-----|---------|------|
| DELETE /api/users/:id | src/routes/users.ts | ユーザー削除API |

#### 推奨アクション
- [ ] docs/design/api/users.mdに削除APIを追加
- [ ] 不要な実装なら削除

## データベース乖離詳細

[同様の形式で記載]

## コンポーネント乖離詳細

[同様の形式で記載]
```

### ユーザー承認フロー

```text
実装同期チェックが完了しました。

【検出された乖離】
- API: X件
- データベース: X件
- コンポーネント: X件

対応を選択してください：

A) ドキュメントを実装に合わせて更新
B) 実装をドキュメントに合わせて修正（タスク作成）
C) 個別に対応を選択
D) 今回は修正せずレポートのみ保存
```

---

## 機能3: アーカイブ (archive)

完了済みタスクや古い決定事項をアーカイブディレクトリに移動します。

### アーカイブ対象

| 対象 | 条件 | 移動先 |
|-----|------|--------|
| 完了タスク | ステータスがDONE | docs/archive/tasks/phase-N/ |
| 古い決定事項 | 明示的に指定 or 一定期間経過 | docs/archive/decisions/ |
| 古いトラブルシューティング | 修正完了から一定期間経過 | docs/archive/troubleshooting/ |

### ディレクトリ構造

```text
docs/
├── requirements/
├── design/
├── tasks/
├── troubleshooting/
└── archive/                    # アーカイブ
    ├── tasks/                  # 完了済みタスク
    │   ├── phase-1/
    │   │   ├── TASK-001.md
    │   │   └── TASK-002.md
    │   └── phase-2/
    ├── decisions/              # 古い決定事項
    │   └── DEC-001.md
    └── troubleshooting/        # 完了した問題分析
        └── 2024-01-15-login-bug/
```

### 実行手順

```text
1. docs/tasks/からステータスDONEのタスクを検出
2. アーカイブ対象リストを作成
3. ★ ユーザーに提示し承認を得る ★
4. 承認されたファイルをdocs/archive/に移動
5. 移動元のindex.mdを更新
6. アーカイブのindex.mdを更新
```

### アーカイブ時の処理

1. **ファイル移動**
   - 元のディレクトリ構造を維持
   - タイムスタンプをファイル名に付与（オプション）

2. **インデックス更新**
   - 移動元のindex.mdからエントリを削除
   - アーカイブのindex.mdにエントリを追加

3. **参照の保持**
   - 他ドキュメントからの参照がある場合は警告
   - 必要に応じてリンクを更新

### レポート形式

```markdown
# アーカイブ対象レポート

## 実行日時
[YYYY-MM-DD HH:MM]

## 完了済みタスク

| タスクID | タスク名 | 完了日 | フェーズ |
|---------|---------|--------|---------|
| TASK-001 | ユーザー認証の実装 | 2024-01-10 | phase-1 |
| TASK-002 | API設計の実装 | 2024-01-12 | phase-1 |

### 移動先
- docs/tasks/phase-1/TASK-001.md → docs/archive/tasks/phase-1/TASK-001.md
- docs/tasks/phase-1/TASK-002.md → docs/archive/tasks/phase-1/TASK-002.md

## 古い決定事項

| 決定ID | 決定内容 | 決定日 |
|--------|---------|--------|
| DEC-001 | 認証方式の選定 | 2024-01-05 |

### 移動先
- docs/design/decisions/DEC-001.md → docs/archive/decisions/DEC-001.md

## 参照確認

以下のファイルがアーカイブ対象を参照しています：

| 参照元 | 参照先 | 対応 |
|--------|-------|------|
| docs/design/components/auth.md | TASK-001 | リンク更新が必要 |
```

### ユーザー承認フロー

```text
アーカイブ対象を検出しました。

【アーカイブ対象】
- 完了済みタスク: X件
- 古い決定事項: X件

【参照への影響】
- リンク更新が必要: X件

対応を選択してください：

A) すべてアーカイブ（リンクも自動更新）
B) 個別に選択
C) 今回はアーカイブしない
```

---

## 機能4: ファイル最適化 (optimize)

肥大化したファイルの分割や重複内容の統合を提案します。

### 最適化観点

#### 1. ファイルサイズ

| 状態 | 基準 | アクション |
|-----|------|-----------|
| 正常 | 500行未満 | なし |
| 注意 | 500-1000行 | 分割を検討 |
| 要対応 | 1000行以上 | 分割を推奨 |

#### 2. セクション数

| 状態 | 基準 | アクション |
|-----|------|-----------|
| 正常 | 10セクション未満 | なし |
| 注意 | 10-20セクション | 分割を検討 |
| 要対応 | 20セクション以上 | 分割を推奨 |

#### 3. 重複コンテンツ

| 状態 | 基準 | アクション |
|-----|------|-----------|
| 軽微 | 類似度30%未満 | なし |
| 注意 | 類似度30-50% | 統合を検討 |
| 要対応 | 類似度50%以上 | 統合を推奨 |

### 分割パターン

#### パターンA: 機能別分割

```text
Before:
  docs/design/components/all-components.md (1500行)

After:
  docs/design/components/
  ├── index.md (概要・目次)
  ├── auth.md (認証関連)
  ├── user.md (ユーザー管理)
  └── notification.md (通知関連)
```

#### パターンB: フェーズ別分割

```text
Before:
  docs/tasks/all-tasks.md (2000行)

After:
  docs/tasks/
  ├── index.md (概要・進捗サマリ)
  ├── phase-1/ (フェーズ1タスク)
  ├── phase-2/ (フェーズ2タスク)
  └── phase-3/ (フェーズ3タスク)
```

### 実行手順

```text
1. docs/配下のすべてのMarkdownファイルを走査
2. ファイルサイズ、セクション数を計測
3. 重複コンテンツを検出
4. 最適化提案レポートを作成
5. ★ ユーザーに提示し承認を得る ★
6. 承認された最適化を実行
```

### レポート形式

```markdown
# ファイル最適化レポート

## 実行日時
[YYYY-MM-DD HH:MM]

## サマリー

| カテゴリ | 正常 | 注意 | 要対応 |
|---------|-----|------|--------|
| サイズ超過 | X件 | X件 | X件 |
| セクション過多 | X件 | X件 | X件 |
| 重複コンテンツ | - | X件 | X件 |

## 分割推奨ファイル

### docs/design/components/auth.md

| 項目 | 値 |
|-----|-----|
| 現在の行数 | 1,200行 |
| セクション数 | 25 |
| 状態 | 要対応 |

#### 分割提案

```text
docs/design/components/
├── auth/
│   ├── index.md (概要・目次)
│   ├── authentication.md (認証処理)
│   ├── authorization.md (認可処理)
│   └── session.md (セッション管理)
```

#### 分割後の構成

| ファイル | 内容 | 推定行数 |
|---------|------|---------|
| index.md | 概要、コンポーネント一覧 | 100行 |
| authentication.md | ログイン、ログアウト、トークン管理 | 400行 |
| authorization.md | 権限チェック、ロール管理 | 350行 |
| session.md | セッション作成、更新、破棄 | 350行 |

## 重複コンテンツ

### 類似度: 65%

| ファイルA | ファイルB |
|----------|----------|
| docs/requirements/stories/US-005.md | docs/design/components/user.md |

#### 重複箇所
- ユーザー属性の定義（両方に同じ内容）
- バリデーションルール（両方に同じ内容）

#### 推奨アクション
- [ ] 共通定義をdocs/design/common/user-attributes.mdに抽出
- [ ] 各ファイルから参照に変更

## インデックス再生成

以下のindex.mdが目次と実際のファイルで不一致があります：

| ファイル | 問題 |
|---------|------|
| docs/tasks/index.md | 5件のタスクが目次にない |
| docs/design/index.md | 2件の削除済みファイルが目次に残っている |
```

### ユーザー承認フロー

```text
ファイル最適化分析が完了しました。

【検出された問題】
- 分割推奨: X件
- 重複コンテンツ: X件
- インデックス不整合: X件

対応を選択してください：

A) すべての最適化を実行
B) 分割のみ実行
C) インデックス再生成のみ実行
D) 個別に選択
E) 今回は実行せずレポートのみ保存
```

---

## ユーザー対話ガイドライン

### スキル起動時

```text
SDDドキュメント管理を開始します。

どの機能を実行しますか？

1. 整合性チェック - ドキュメント間の矛盾を検出
2. 実装同期チェック - 実装とドキュメントの乖離を検出
3. アーカイブ - 完了タスク・古い決定事項を整理
4. ファイル最適化 - 肥大化ファイルの分割・重複統合
5. フルスキャン - 上記すべてを実行
```

### 問題検出時

```text
[機能名]が完了しました。

【検出結果サマリー】
[サマリー表]

詳細を確認しますか？
- 詳細を表示する場合は「詳細」
- 修正に進む場合は「修正」
- スキップする場合は「スキップ」
```

### 修正実行前

```text
以下の修正を実行します：

[修正内容リスト]

実行してよろしいですか？（はい/いいえ）
```

### 修正完了時

```text
修正が完了しました。

【実行結果】
- 修正したファイル: X件
- 移動したファイル: X件
- 更新したインデックス: X件

変更内容をコミットしますか？（はい/いいえ）
```

---

## 成果物の保存

### レポート保存先

```text
docs/
└── reports/                    # 管理レポート
    ├── consistency/            # 整合性チェックレポート
    │   └── [YYYY-MM-DD].md
    ├── sync/                   # 実装同期チェックレポート
    │   └── [YYYY-MM-DD].md
    ├── archive/                # アーカイブレポート
    │   └── [YYYY-MM-DD].md
    └── optimize/               # 最適化レポート
        └── [YYYY-MM-DD].md
```

### レポート保持期間

- 直近10件のレポートを保持
- 古いレポートは自動削除（オプション）

---

## SDDワークフローとの統合

```text
sdd-documentation
    │
    ├── requirements-defining → docs/requirements/
    ├── software-designing   → docs/design/
    ├── task-planning        → docs/tasks/
    ├── task-executing       → 実装コード
    ├── sdd-troubleshooting  → 問題分析・修正タスク
    │
    └── sdd-document-management → ドキュメント管理（このスキル）
```

### 推奨実行タイミング

| タイミング | 推奨機能 |
|-----------|---------|
| フェーズ完了時 | アーカイブ、ファイル最適化 |
| リリース前 | フルスキャン（すべての機能） |
| 定期メンテナンス | 整合性チェック、実装同期チェック |
| 仕様変更後 | 整合性チェック |
| 大規模実装後 | 実装同期チェック |

---

## エージェントチームによる並列チェック

### 概要

フルスキャン実行時に、エージェントチームを活用して4つのチェック機能を並列実行できます。各チームメンバーが独立したチェック機能を担当し、結果をリーダーが統合します。

### 適用条件

- フルスキャン（すべての機能を実行）を選択した場合
- プロジェクトの規模が大きく、順次実行では時間がかかる場合

### チーム構成

```text
チームリーダー（sdd-document-management）
    │
    ├── チームメンバーA: 整合性チェック (consistency-check)
    │   - requirements ↔ design ↔ tasks の矛盾検出
    │   - 成果物: docs/reports/consistency/[date].md
    │
    ├── チームメンバーB: 実装同期チェック (sync-check)
    │   - 実装コードとドキュメントの乖離検出
    │   - 成果物: docs/reports/sync/[date].md
    │
    ├── チームメンバーC: アーカイブ対象検出 (archive)
    │   - 完了タスク・古い決定事項のリストアップ
    │   - 成果物: docs/reports/archive/[date].md
    │
    └── チームメンバーD: ファイル最適化分析 (optimize)
        - 肥大化ファイル・重複検出
        - 成果物: docs/reports/optimize/[date].md
```

### スポーンプロンプト例

```text
エージェントチームを作成して、SDDドキュメントのフルスキャンを並列実行してください。

プロジェクトルート: [プロジェクトパス]
ドキュメントディレクトリ: docs/

チームメンバーの役割:
- メンバー1（整合性チェック）: docs/requirements/ ↔ docs/design/ ↔ docs/tasks/ の矛盾を検出
- メンバー2（実装同期チェック）: docs/design/ と実装コードの乖離を検出
- メンバー3（アーカイブ対象検出）: 完了タスクと古い決定事項をリストアップ
- メンバー4（ファイル最適化分析）: 肥大化ファイルと重複コンテンツを検出

各メンバーはレポートファイルのみ作成し、実際の修正は行わないでください。
レポート完了後、リーダーに結果を送信してください。
```

### 並列チェック後のフロー

```text
1. 各チームメンバーがレポートを作成
2. リーダーが全レポートを統合
3. 統合サマリーをユーザーに提示
4. ★ ユーザー承認 ★
5. 承認された修正を順次実行（ファイル競合を考慮して順次）
```

### 注意事項

- レポート作成は並列可能だが、修正の実行は順次で行う（ファイル競合回避）
- 各チームメンバーはdocs/reports/の自分のディレクトリにのみ書き込む
- リーダーは統合サマリー作成後、必ずユーザー承認を得る

## TodoWrite連携

### アーカイブ時の同期

タスクをアーカイブした場合、TodoWriteからも該当タスクを削除（またはcompletedのまま維持）:

```text
1. docs/tasks/からdocs/archive/tasks/にタスクを移動
2. TodoWriteから該当タスクを除外（completedのタスクは新しいtodoリストに含めない）
```

### 整合性チェックでタスク追加時

不整合の修正タスクを追加した場合、TodoWriteにも追加:

```text
todos = [
  ...既存のtodo...,
  { content: "[TASK-XXX] [DocFix] 設計書の整合性修正", status: "pending", activeForm: "[TASK-XXX] 設計書の整合性を修正中" }
]
```

## ベストプラクティス

### 1. 定期的な実行

- 週次または隔週で整合性チェックを実行
- フェーズ完了ごとにアーカイブを実行
- リリース前にフルスキャンを実行

### 2. 小さな修正の積み重ね

- 大量の問題を一度に修正しない
- 優先度の高い問題から順に対応
- 各修正後に動作確認

### 3. 承認プロセスの遵守

- 自動修正に頼らず必ずレポートを確認
- 不明な点はユーザーに確認
- 修正内容を記録に残す

### 4. バックアップの確保

- アーカイブ前にgit commitを確認
- 大規模な最適化前にブランチを作成
- 元に戻せる状態を維持

### 5. エージェントチームの活用

- フルスキャン時はチームによる並列実行を検討
- 修正実行は順次で行い、ファイル競合を回避
- チーム完了後は必ずレポートを統合してからユーザーに提示

---

## リソース

### リファレンス
- 管理ガイドライン: `references/management_guide_ja.md`

### テンプレート
- 整合性チェックレポート: `assets/templates/consistency_report_template_ja.md`
- 実装同期チェックレポート: `assets/templates/sync_report_template_ja.md`
- アーカイブレポート: `assets/templates/archive_report_template_ja.md`
- 最適化レポート: `assets/templates/optimize_report_template_ja.md`

### 関連スキル
- オーケストレーター: `sdd-documentation/SKILL.md`
- 要件定義: `requirements-defining/SKILL.md`
- 設計: `software-designing/SKILL.md`
- タスク計画: `task-planning/SKILL.md`
- タスク実行: `task-executing/SKILL.md`
- トラブルシューティング: `sdd-troubleshooting/SKILL.md`
