# タスク実行ガイド

task-executingスキルの詳細な実行手順とエラーハンドリングガイドです。

## タスク実行の詳細ステップ

### ステップ1: タスクの読み取りと分析

```text
1. docs/tasks/index.mdを読み取る
2. TODO状態のタスクをフィルタリング
3. 各タスクの詳細ファイル（docs/tasks/[phase]/TASK-XXX.md）を読み込む
4. 各タスクの情報を抽出
   - タスクID
   - タスクタイトル
   - 説明
   - 受入基準
   - 依存関係
   - ステータス
   - 推定工数
5. 依存関係を確認
```

### ステップ2: 実行計画の提示

```text
以下のタスクを実行します：

【実行対象】
- Task 1.1: ユーザー認証APIエンドポイントの実装
  依存関係: なし
  推定工数: 30分

【実行手順】
1. ステータスをIN_PROGRESSに更新
2. サブエージェントで実装
3. 受入基準を確認
4. タスク完了前チェックリスト確認
5. コミット作成
6. ステータスをDONEに更新
7. 逆順レビュー実施

実行を開始してよろしいですか？
```

### ステップ3: 実装実行

サブエージェントに以下の情報を提供：
- タスクファイル（TASK-XXX.md）の完全な内容
- 受入基準
- 技術的文脈
- 参照すべき既存コード
- docs/design/、docs/requirements/の関連ファイル

### ステップ4: 受入基準の確認

実装完了後、すべての受入基準を確認：

```text
【受入基準の確認】
- [x] login/logoutエンドポイントが実装されている
- [x] JWTトークンが正しく生成・検証される
- [x] パスワードがbcryptでハッシュ化されている
- [x] エラーハンドリングが適切に実装されている
- [x] ユニットテストが実装され、すべて通過する

すべての受入基準を達成しました。コミットを作成します。
```

### ステップ5: タスク完了前チェックリスト確認

タスク完了をマークする前に、タスク内容を分析して該当するカテゴリのチェックリストを提示し、確認を促します。

#### カテゴリの判定基準

| カテゴリ | 判定条件 |
|---------|---------|
| UI変更 | タスクの説明・受入基準に「コンポーネント」「画面」「レイアウト」「CSS」「スタイル」が含まれる |
| 外部システム連携 | 「Docker」「Git」「API連携」「ファイルシステム」「マウント」が含まれる |
| データ操作 | 「データベース」「クエリ」「リスト」「配列」「入力」「バリデーション」が含まれる |
| コンポーネント再利用 | 「共通化」「リファクタリング」「移動」「再利用」が含まれる |

#### チェックリスト提示の例

```text
【タスク完了前チェック】

Task 2.1: Dockerコンテナ起動スクリプトの実装

該当カテゴリ:
- 外部システム連携（Docker/Git等）を含む

チェックリスト:
[外部システム連携]
- [ ] モックではなく実際のシステムで動作確認した
- [ ] 権限・マウント設定の相互作用を確認した
- [ ] エラー時のログ出力・ハンドリングを確認した

上記の項目をすべて確認しましたか？
```

#### 未確認項目がある場合

```text
【警告】以下の項目が未確認です:

- [ ] 権限・マウント設定の相互作用を確認した

この項目を確認せずに完了とする場合、以下のリスクがあります:
- 本番環境でのみ発生するエラーの見落とし
- 環境依存の問題の見落とし

確認を行いますか？それとも警告を承知の上で完了としますか？
```

### ステップ6: コミット作成

コミットテンプレートに従ってコミットを作成。
詳細は `commit_templates_ja.md` を参照。

### ステップ7: 逆順レビュー

実装→タスク→設計→要件の整合性を確認。

## 並列実行（Agentベース）

### 並列実行の条件

- 依存関係フィールドが空、または「なし」
- 前提となるタスクがすべて完了済み
- 異なるファイル・コンポーネントを対象とする

### Agentによる並列実装

**重要**: 並列実行可能なタスクは、Taskツール（subagent_type=general-purpose）を使用して同時に実装を進めます。

```text
【並列実行の手順】
1. docs/tasks/index.mdを分析し、並列実行可能なタスクを特定
2. 各タスクの詳細ファイルを読み込む
3. 各タスクに対してAgentを起動（1つのメッセージで複数のTaskツールを呼び出す）
4. 各Agentは独立してタスクを実装
5. すべてのAgentが完了後、結果を統合
6. 逆順レビューを実施
```

### Agent起動の例

```text
以下のタスクを並列で実行します：

【Task 1.1】ユーザー認証APIの実装
→ Agent 1を起動

【Task 1.2】ユーザー登録APIの実装
→ Agent 2を起動

【Task 1.3】パスワードリセットAPIの実装
→ Agent 3を起動

各Agentには以下の情報を渡します：
- タスクの詳細（説明、受入基準）
- 関連するdocs/design/、docs/requirements/の該当ファイル
- コーディング規約とコミットテンプレート
- テスト要件（カバレッジ80%以上）
```

### Agent実行時の注意事項

1. **コンテキストの共有**: 各Agentに十分な情報を渡す
2. **ファイル競合の回避**: 異なるファイルを対象とするタスクのみ並列化
3. **コミット順序**: 各Agent完了後、メインプロセスで順次コミット
4. **エラーハンドリング**: 1つのAgentが失敗しても他のAgentは継続
5. **結果の検証**: すべてのAgent完了後にテストを実行

## エラーハンドリング

### タスク実行中のエラー

1. エラー内容をユーザーに報告
2. 部分的に完了した作業をコミット（セーフポイント）
3. タスクのステータスをBLOCKEDに変更
4. エラー原因と対処方法を記録
5. ユーザーに次の行動を確認

### エラー報告の例

```text
Task 1.1の実行中にエラーが発生しました：

【エラー内容】
npm install時に依存関係の競合が発生

【実施した内容】
- 基本的なファイル構造を作成（コミット済み）
- パッケージのインストールは未完了

【ステータス】
Task 1.1: BLOCKED

【次の行動】
1. 依存関係の競合を解決してから再実行
2. このタスクをスキップして次のタスクへ進む

どちらにしますか？
```

## 逆順レビュー詳細

### レビューの流れ

```text
実装 → docs/tasks/ → docs/design/ → docs/requirements/
```

### チェック項目

#### 1. 実装 → タスクの整合性

| チェック項目 | 確認内容 |
|-------------|---------|
| 受入基準達成 | すべての受入基準が満たされているか |
| ファイル一致 | タスクで指定されたファイルが作成されているか |
| テスト通過 | 指定されたテストがすべて通過するか |
| コード品質 | ESLint/TypeScriptエラーがないか |

#### 2. タスク → 設計の整合性

| チェック項目 | 確認内容 |
|-------------|---------|
| コンポーネント対応 | 実装がdesign/components/のコンポーネント定義と一致するか |
| API対応 | APIの実装がdesign/api/の仕様と一致するか |
| データモデル対応 | データ構造がdesign/database/のスキーマと一致するか |

#### 3. 設計 → 要件の整合性

| チェック項目 | 確認内容 |
|-------------|---------|
| 要件カバレッジ | 実装が対応する要件（REQ-XXX）を満たしているか |
| 非機能要件 | NFR-XXXの要件が満たされているか |
| 過剰実装チェック | 要件にない機能が実装されていないか |

### 不整合発見時の報告

```text
逆順レビューで以下の不整合を発見しました：

【実装 → タスクの不整合】
1. Task 1.1の受入基準「エラーハンドリングが適切に実装されている」
   が満たされていません。
   → 400エラー時のレスポンス形式がdocs/design/の仕様と異なります。

【タスク → 設計の不整合】
2. 実装したUserServiceにvalidateEmail()メソッドがありますが、
   design/components/user-service.mdのUserService定義に含まれていません。

【設計 → 要件の不整合】
3. REQ-003「パスワードリセット機能」に対応する実装がありません。

対応方法を選択してください：
1. 実装を修正する
2. ドキュメントを更新する（要確認事項として記録）
3. 次のタスクに進む（後で対応）
```

## 制約事項

### 自動実行を行わない場合

1. **タスクの曖昧性**: 受入基準が明確でない、実装方法が複数考えられる
2. **リスクの高い操作**: 本番環境への変更、データベースの削除操作
3. **ユーザーの判断が必要**: 技術選択、アーキテクチャの決定

これらの場合はユーザーに確認を求めます。
