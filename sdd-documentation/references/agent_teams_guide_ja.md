# エージェントチームガイド

## 概要

このガイドでは、SDDワークフローにおけるエージェントチーム機能の活用方法を説明します。エージェントチームを使用することで、独立したタスクを複数のClaude Codeインスタンスが並列で処理し、開発効率を向上させます。

**原則: 条件を満たす場合はエージェントチームを積極的に使用する。「使えたら使う」ではなく「条件を満たせば使う」。**

## エージェントチーム判定フローチャート（全スキル共通）

```text
┌─────────────────────────────────────────────────────┐
│            エージェントチーム判定                      │
├─────────────────────────────────────────────────────┤
│                                                     │
│  Q1. 並列実行可能な独立したタスク/調査が3つ以上？     │
│      YES → Q2へ                                     │
│      NO  → サブエージェント（Task tool）または順次実行│
│                                                     │
│  Q2. 各タスクが異なるファイルセットを対象？           │
│      YES → Q3へ                                     │
│      NO  → 順次実行                                  │
│                                                     │
│  Q3. タスク間に依存関係がない？                       │
│      YES → エージェントチームを作成                   │
│      NO  → 順次実行                                  │
│                                                     │
│  結果:                                               │
│  エージェントチーム → デリゲートモードで作成           │
│  サブエージェント → Task toolで並列起動               │
│  順次実行 → 単一セッションで1つずつ                   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

**補足**: メンバー間の議論・発見共有が有益な場合（例: トラブルシューティングの相互反証）は、サブエージェント（Task tool）よりエージェントチームが特に推奨される。

## エージェントチーム vs サブエージェント（Task tool）

| 基準 | エージェントチーム | サブエージェント（Task tool） |
|------|-------------------|------------------------------|
| **通信** | メンバー間で直接メッセージ送信可能 | メインエージェントにのみ結果を返す |
| **調整** | 共有タスクリストで自己調整 | メインエージェントがすべて管理 |
| **発見の共有** | メンバー間で相互反証・議論が可能 | 不可能 |
| **トークンコスト** | 高い（各メンバーが個別インスタンス） | 低い（結果がメインに要約される） |
| **最適な用途** | 議論・協力が必要な複雑な作業 | 結果のみが重要な焦点を絞ったタスク |

### 各SDDフェーズでの推奨

| フェーズ | 推奨方式 | 理由 |
|---------|---------|------|
| task-executing（3タスク以上、Jules利用可能） | Jules + Agent Teamsハイブリッド | 定型タスクをJulesに非同期委任し、ローカルAgentと並列実行で最大効率 |
| task-executing（3タスク以上、Jules利用不可） | エージェントチーム | 問題発見時にメンバー間で共有できる |
| task-executing（1-2タスク、Jules利用可能） | Jules単体で非同期依頼 | チーム不要、PRベースで進捗管理 |
| task-executing（1-2タスク、Jules利用不可） | サブエージェント（Task tool） | チームのオーバーヘッドが利益を超える |
| sdd-troubleshooting（3仮説以上） | エージェントチーム | 相互反証が精度を向上させる |
| sdd-document-management（フルスキャン） | エージェントチーム | 4機能の独立した並列実行に最適 |
| 逆順レビュー（3層チェック） | エージェントチーム | レイヤー間の発見を共有できる |
| 要件定義・設計 | 単一セッション | ユーザー対話が中心 |

## 前提条件

### 有効化

エージェントチームは実験的機能です。settings.jsonまたは環境変数で有効化してください:

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

### 表示モード

| モード | 説明 | 設定 |
|--------|------|------|
| in-process | メインターミナル内で実行。Shift+Up/Downでメンバー切替 | デフォルト |
| split panes | 各メンバーが独自ペイン。tmuxまたはiTerm2が必要 | `"teammateMode": "tmux"` |

## SDDワークフローでのチーム活用

### 活用マップ

```text
SDDフェーズ          チーム利用         条件・トリガー                    Jules CLI利用
──────────────────────────────────────────────────────────────────────────────────────
1. 要件定義          不要               ユーザー対話が中心                不要
2. 設計              不要               ユーザー対話が中心                不要
3. タスク計画        不要（設計時考慮）  並列実行を前提にタスク設計        不要
4. 逆順レビュー      条件付き必須        3層すべて存在する場合             PR含む場合対象
5. タスク実行        条件付き必須        並列可能タスク3つ以上の場合       ハイブリッド推奨
6. トラブルシュート   条件付き必須        原因候補3つ以上の場合             不要
7. ドキュメント管理   フルスキャン時必須  フルスキャン選択時                不要
```

### パターン1: 並列タスク実行

**使用フェーズ**: タスク実行（task-executing）

**条件**:
- 3つ以上の独立したタスク
- 各タスクが異なるファイルを対象
- タスク間に依存関係なし

**手順**:

1. docs/sdd/tasks/index.mdから並列実行可能なタスクグループを特定
2. チームを作成し、各タスクにチームメンバーを割り当て
3. デリゲートモード（Shift+Tab）でリーダーは成果確認・進捗管理に専念（実装禁止）
4. 各メンバーの完了を待機し、成果をレビュー
5. 全完了後にindex.mdとTodoWriteを一括更新
6. 逆順レビューを実施

**スポーンプロンプトテンプレート**:

```text
エージェントチームを作成して、以下のSDDタスクを並列実行してください。
各チームメンバーにはtask-executingの手順に従って実装を進めてもらいます。
プラン承認は不要です。

タスク割り当て:
- メンバー1: docs/sdd/tasks/phase-{N}/TASK-{XXX}.md
  対象ファイル: {ファイルリスト}
- メンバー2: docs/sdd/tasks/phase-{N}/TASK-{YYY}.md
  対象ファイル: {ファイルリスト}
- メンバー3: docs/sdd/tasks/phase-{N}/TASK-{ZZZ}.md
  対象ファイル: {ファイルリスト}

共通ルール:
- タスクファイルのTDD手順に従う
- 自分の担当ファイルのみ編集する
- タスク完了後にステータスをDONEに更新しコミット作成
- 完了後にリーダーへメッセージ送信

Sonnetモデルを使用してください。
```

### パターン2: 並列レビュー

**使用フェーズ**: 逆順レビュー

**条件**:
- ドキュメントが3層（requirements/design/tasks）すべて存在
- 実装コードが存在する場合は実装同期チェックも追加

**チーム構成**:

```text
リーダー（統合・報告）
├── レビュアーA: requirements ↔ design 整合性
├── レビュアーB: design ↔ tasks 整合性
└── レビュアーC: implementation ↔ docs 同期（実装がある場合）
```

### パターン3: 競合仮説デバッグ

**使用フェーズ**: トラブルシューティング（sdd-troubleshooting）

**条件**:
- 原因候補が3つ以上
- 各仮説の調査が独立して実行可能

**チーム構成**:

```text
リーダー（統合・判定）
├── 調査員A: 仮説1を調査
├── 調査員B: 仮説2を調査
└── 調査員C: 仮説3を調査
```

**重要**: チームメンバーに互いの発見を共有・反証させることで、精度を向上させる。

### パターン4: 並列ドキュメントチェック

**使用フェーズ**: ドキュメント管理（sdd-document-management）フルスキャン時

**チーム構成**:

```text
リーダー（統合・ユーザー承認）
├── メンバーA: 整合性チェック → docs/sdd/reports/consistency/
├── メンバーB: 実装同期チェック → docs/sdd/reports/sync/
├── メンバーC: アーカイブ対象検出 → docs/sdd/reports/archive/
└── メンバーD: ファイル最適化分析 → docs/sdd/reports/optimize/
```

**注意**: レポート作成は並列、修正実行は順次。

## チーム運用のベストプラクティス

### 1. ファイル競合を避ける

各チームメンバーが編集するファイルセットを明確に分離:

```text
メンバーA: src/auth/** のみ
メンバーB: src/api/** のみ
メンバーC: src/models/** のみ
```

**絶対に避けるべき**: 複数メンバーが同一ファイルを編集

### 2. 十分なコンテキストを提供

チームメンバーはリーダーの会話履歴を引き継がないため、スポーンプロンプトに必要な情報をすべて含める:

- タスクファイルのパス
- 対象ファイルのパス
- 参照すべき設計ドキュメント
- 使用する技術スタック
- コーディング規約

### 3. リーダーは実装せず成果確認に専念

リーダーが自ら実装を始めないよう、Shift+Tabでデリゲートモードに切り替え:

- **リーダーの役割（実装コード変更禁止）**: タスク分配、進捗監視、メンバーの成果レビュー、index.md/TodoWriteの一括更新のみ行う。実装コードや実装ファイルの編集は禁止。ただし、docs/sdd/tasks/index.mdやTodoWrite等の管理系更新はリーダーが行う
- **メンバーの役割**: 割り当てられたタスクの実装、テスト、コミット作成を担当

### 4. プラン承認を活用

リスクの高いタスク（DB操作、認証変更等）では、チームメンバーにプラン承認を要求:

```text
このタスクはデータベーススキーマを変更するため、プラン承認を要求してください。
メンバーがプランを提出したら、以下を確認してからのみ承認:
- マイグレーションが可逆的か
- 既存データへの影響がないか
- テストが含まれているか
```

### 5. 完了待機を徹底

リーダーがメンバーの完了前に次のフェーズに進まないよう指示:

```text
すべてのチームメンバーのタスクが完了するまで待ってください。
完了後に逆順レビューを実施します。
```

### パターン5: Jules CLI + Agent Teamsハイブリッド実行

**使用フェーズ**: タスク実行（task-executing）でJules CLIが利用可能な場合

**条件**:
- Jules CLIが利用可能（`jules --version`で確認）
- 3つ以上の独立したタスク
- 開発ブランチが指定されている

**チーム構成**:

```text
チームリーダー（オーケストレーター）
├── Jules依頼管理:
│   ├── Jules-1: TASK-001（定型的な実装）→ PR作成
│   ├── Jules-2: TASK-002（定型的な実装）→ PR作成
│   └── Jules-3: TASK-003（定型的な実装）→ PR作成
├── ローカルAgent（環境依存・対話的タスク）:
│   ├── Agent-1: TASK-004（Docker設定等）
│   └── Agent-2: TASK-005（複雑なリファクタリング等）
└── 管理業務:
    ├── jules listで定期的に進捗確認
    ├── PRレビュー・マージ管理
    ├── docs/sdd/tasks/の一括更新
    └── TodoWriteの同期
```

**タスク割り当て判定基準**:

| 実行先 | 向いているタスク |
|--------|-----------------|
| **Jules** | 独立・定型的・明確な受入基準・標準パターン（CRUD、API、モデル定義） |
| **ローカルAgent** | 複雑なリファクタリング・対話的判断・環境依存・密結合な変更 |

**スポーンプロンプトテンプレート**:

```text
エージェントチームを作成して、以下のSDDタスクを最大効率で実行してください。
Jules CLIが利用可能です。タスクをJules向けとローカル向けに分類して実行します。
プラン承認は不要です。

開発ブランチ: {ブランチ名}

【Jules依頼タスク】（PRベースで非同期実行）
- Jules-1: docs/sdd/tasks/phase-{N}/TASK-{XXX}.md
  PR作成先: {開発ブランチ}
- Jules-2: docs/sdd/tasks/phase-{N}/TASK-{YYY}.md
  PR作成先: {開発ブランチ}
- Jules-3: docs/sdd/tasks/phase-{N}/TASK-{ZZZ}.md
  PR作成先: {開発ブランチ}

【ローカル実行タスク】（Agent Teamsで並列実行）
- Agent-1: docs/sdd/tasks/phase-{N}/TASK-{AAA}.md
  対象ファイル: {ファイルリスト}
- Agent-2: docs/sdd/tasks/phase-{N}/TASK-{BBB}.md
  対象ファイル: {ファイルリスト}

共通ルール:
- Jules: 依頼文にPR作成先を明記し、julesコマンドで同時依頼
- ローカルAgent: タスクファイルのTDD手順に従い、自分の担当ファイルのみ編集
- リーダー: jules listで定期確認、PR作成されたらレビュー
- 全タスク完了後にindex.mdとTodoWriteを一括更新
- 逆順レビューを実施

Sonnetモデルを使用してください。
```

**依存関係グループの順次進行**:

```text
グループA（並列: Jules-1, Jules-2, Jules-3, Agent-1）
  ↓ 全PRマージ + Agent完了
開発ブランチを最新に更新（git pull）
  ↓
グループB（並列: Jules-4, Jules-5, Agent-2）
  ↓ 全PRマージ + Agent完了
逆順レビュー

※ Jules番号はセッション通しの連番。グループBで新たにJulesに依頼する際は
  グループAの続番（Jules-4〜）を使用する。
```

**進捗管理**:

リーダーは以下の方法で全実行先の進捗を一元管理:

```text
Jules進捗: jules list で確認
  - 作業中 → SDD: IN_PROGRESS
  - PR作成済み → SDD: REVIEW
  - PRマージ済み → SDD: DONE

ローカルAgent進捗: チームメンバーからの完了メッセージ
  - 完了報告 → SDD: DONE

TodoWrite同期: リーダーが一括更新（マージプロトコルに従う）
```

## エージェントチームを使用しない場合

以下の場合はサブエージェント（Task tool）または順次実行を使用する:

| 状況 | 理由 | 代替手段 |
|------|------|---------|
| 1-2個のタスク | オーバーヘッドが利益を超える | サブエージェント（Task tool） |
| 同一ファイルを複数が編集 | 上書き競合が発生する | 順次実行 |
| 順序依存タスク | 前タスクの結果が次に必要 | 順次実行 |
| 要件定義・設計フェーズ | ユーザー対話が中心 | 単一セッション |
| 結果のみ必要で議論不要 | メンバー間通信が不要 | サブエージェント（Task tool） |
| Jules CLIのみで十分 | ローカルAgentが不要 | Jules CLIスキル単体 |

**重要**: 上記に該当しない場合（3つ以上の独立タスク、異なるファイルセット、依存関係なし）は、エージェントチームを使用すること。Jules CLIが利用可能な場合はハイブリッド実行（パターン5）を積極的に検討すること。

## トラブルシューティング

### メンバーが応答しない

Shift+Up/Down（in-processモード）またはペインクリック（split-paneモード）でメンバーの状態を確認。必要に応じて新しいメンバーをスポーン。

### ファイル競合が発生した

1. 競合したチームメンバーを停止
2. gitで競合を解消
3. 片方のメンバーに作業を再割り当て

### リーダーが自ら実装を始めてしまう

リーダーが実装作業を行うのは設計違反。以下を指示:

```text
あなたはチームリーダーです。自分では実装・コード変更を行わないでください。
チームメンバーの進捗確認と成果レビューに専念し、全メンバーの完了を待ってください。
```

### チームの後片付け

作業完了後は必ずリーダーにクリーンアップを指示:

```text
チームをクリーンアップしてください
```
