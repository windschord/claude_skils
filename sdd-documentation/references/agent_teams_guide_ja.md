# エージェントチームガイド

## 概要

このガイドでは、SDDワークフローにおけるエージェントチーム機能の活用方法を説明します。エージェントチームを使用することで、独立したタスクを複数のClaude Codeインスタンスが並列で処理し、開発効率を向上させます。

**原則: 条件を満たす場合はエージェントチームを積極的に使用する。「使えたら使う」ではなく「条件を満たせば使う」。**

## エージェントチーム判定フローチャート（全スキル共通）

```text
┌─────────────────────────────────────────────────────┐
│            エージェントチーム判定                      │
├─────────────────────────────────────────────────────┤
│                                                     │
│  Q1. 並列実行可能な独立したタスク/調査が3つ以上？     │
│      YES → Q2へ                                     │
│      NO  → サブエージェント（Task tool）または順次実行│
│                                                     │
│  Q2. 各タスクが異なるファイルセットを対象？           │
│      YES → Q3へ                                     │
│      NO  → 順次実行                                  │
│                                                     │
│  Q3. メンバー間の議論・発見共有が有益？               │
│      YES → エージェントチームを作成                   │
│      NO  → サブエージェント（Task tool）でも可        │
│             （ただし3つ以上ならチーム推奨）            │
│                                                     │
│  結果:                                               │
│  エージェントチーム → デリゲートモードで作成           │
│  サブエージェント → Task toolで並列起動               │
│  順次実行 → 単一セッションで1つずつ                   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## エージェントチーム vs サブエージェント（Task tool）

| 基準 | エージェントチーム | サブエージェント（Task tool） |
|------|-------------------|------------------------------|
| **通信** | メンバー間で直接メッセージ送信可能 | メインエージェントにのみ結果を返す |
| **調整** | 共有タスクリストで自己調整 | メインエージェントがすべて管理 |
| **発見の共有** | メンバー間で相互反証・議論が可能 | 不可能 |
| **トークンコスト** | 高い（各メンバーが個別インスタンス） | 低い（結果がメインに要約される） |
| **最適な用途** | 議論・協力が必要な複雑な作業 | 結果のみが重要な焦点を絞ったタスク |

### 各SDDフェーズでの推奨

| フェーズ | 推奨方式 | 理由 |
|---------|---------|------|
| task-executing（3タスク以上） | エージェントチーム | 問題発見時にメンバー間で共有できる |
| task-executing（1-2タスク） | サブエージェント（Task tool） | オーバーヘッドが利益を超える |
| sdd-troubleshooting（3仮説以上） | エージェントチーム | 相互反証が精度を向上させる |
| sdd-document-management（フルスキャン） | エージェントチーム | 4機能の独立した並列実行に最適 |
| 逆順レビュー（3層チェック） | エージェントチーム | レイヤー間の発見を共有できる |
| 要件定義・設計 | 単一セッション | ユーザー対話が中心 |

## 前提条件

### 有効化

エージェントチームは実験的機能です。settings.jsonまたは環境変数で有効化してください:

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

### 表示モード

| モード | 説明 | 設定 |
|--------|------|------|
| in-process | メインターミナル内で実行。Shift+Up/Downでメンバー切替 | デフォルト |
| split panes | 各メンバーが独自ペイン。tmuxまたはiTerm2が必要 | `"teammateMode": "tmux"` |

## SDDワークフローでのチーム活用

### 活用マップ

```text
SDDフェーズ          チーム利用         条件・トリガー
──────────────────────────────────────────────────────
1. 要件定義          不要               ユーザー対話が中心
2. 設計              不要               ユーザー対話が中心
3. タスク計画        不要（設計時考慮）  並列実行を前提にタスク設計
4. 逆順レビュー      条件付き必須        3層すべて存在する場合
5. タスク実行        条件付き必須        並列可能タスク3つ以上の場合
6. トラブルシュート   条件付き必須        原因候補3つ以上の場合
7. ドキュメント管理   フルスキャン時必須  フルスキャン選択時
```

### パターン1: 並列タスク実行

**使用フェーズ**: タスク実行（task-executing）

**条件**:
- 3つ以上の独立したタスク
- 各タスクが異なるファイルを対象
- タスク間に依存関係なし

**手順**:

1. docs/tasks/index.mdから並列実行可能なタスクグループを特定
2. チームを作成し、各タスクにチームメンバーを割り当て
3. デリゲートモード（Shift+Tab）でリーダーは調整に専念
4. 各メンバーの完了を待機
5. 全完了後にTodoWriteを一括更新
6. 逆順レビューを実施

**スポーンプロンプトテンプレート**:

```text
エージェントチームを作成して、以下のSDDタスクを並列実行してください。
各チームメンバーにはtask-executingの手順に従って実装を進めてもらいます。
プラン承認は不要です。

タスク割り当て:
- メンバー1: docs/tasks/phase-{N}/TASK-{XXX}.md
  対象ファイル: {ファイルリスト}
- メンバー2: docs/tasks/phase-{N}/TASK-{YYY}.md
  対象ファイル: {ファイルリスト}
- メンバー3: docs/tasks/phase-{N}/TASK-{ZZZ}.md
  対象ファイル: {ファイルリスト}

共通ルール:
- タスクファイルのTDD手順に従う
- 自分の担当ファイルのみ編集する
- タスク完了後にステータスをDONEに更新しコミット作成
- 完了後にリーダーへメッセージ送信

Sonnetモデルを使用してください。
```

### パターン2: 並列レビュー

**使用フェーズ**: 逆順レビュー

**条件**:
- ドキュメントが3層（requirements/design/tasks）すべて存在
- 実装コードが存在する場合は実装同期チェックも追加

**チーム構成**:

```text
リーダー（統合・報告）
├── レビュアーA: requirements ↔ design 整合性
├── レビュアーB: design ↔ tasks 整合性
└── レビュアーC: implementation ↔ docs 同期（実装がある場合）
```

### パターン3: 競合仮説デバッグ

**使用フェーズ**: トラブルシューティング（sdd-troubleshooting）

**条件**:
- 原因候補が3つ以上
- 各仮説の調査が独立して実行可能

**チーム構成**:

```text
リーダー（統合・判定）
├── 調査員A: 仮説1を調査
├── 調査員B: 仮説2を調査
└── 調査員C: 仮説3を調査
```

**重要**: チームメンバーに互いの発見を共有・反証させることで、精度を向上させる。

### パターン4: 並列ドキュメントチェック

**使用フェーズ**: ドキュメント管理（sdd-document-management）フルスキャン時

**チーム構成**:

```text
リーダー（統合・ユーザー承認）
├── メンバーA: 整合性チェック → docs/reports/consistency/
├── メンバーB: 実装同期チェック → docs/reports/sync/
├── メンバーC: アーカイブ対象検出 → docs/reports/archive/
└── メンバーD: ファイル最適化分析 → docs/reports/optimize/
```

**注意**: レポート作成は並列、修正実行は順次。

## チーム運用のベストプラクティス

### 1. ファイル競合を避ける

各チームメンバーが編集するファイルセットを明確に分離:

```text
メンバーA: src/auth/** のみ
メンバーB: src/api/** のみ
メンバーC: src/models/** のみ
```

**絶対に避けるべき**: 複数メンバーが同一ファイルを編集

### 2. 十分なコンテキストを提供

チームメンバーはリーダーの会話履歴を引き継がないため、スポーンプロンプトに必要な情報をすべて含める:

- タスクファイルのパス
- 対象ファイルのパス
- 参照すべき設計ドキュメント
- 使用する技術スタック
- コーディング規約

### 3. デリゲートモードを使う

リーダーが自ら実装を始めないよう、Shift+Tabでデリゲートモードに切り替え:

- リーダー: タスク分配・進捗管理・結果統合に専念
- メンバー: 実際の実装を担当

### 4. プラン承認を活用

リスクの高いタスク（DB操作、認証変更等）では、チームメンバーにプラン承認を要求:

```text
このタスクはデータベーススキーマを変更するため、プラン承認を要求してください。
メンバーがプランを提出したら、以下を確認してからのみ承認:
- マイグレーションが可逆的か
- 既存データへの影響がないか
- テストが含まれているか
```

### 5. 完了待機を徹底

リーダーがメンバーの完了前に次のフェーズに進まないよう指示:

```text
すべてのチームメンバーのタスクが完了するまで待ってください。
完了後に逆順レビューを実施します。
```

## エージェントチームを使用しない場合

以下の場合はサブエージェント（Task tool）または順次実行を使用する:

| 状況 | 理由 | 代替手段 |
|------|------|---------|
| 1-2個のタスク | オーバーヘッドが利益を超える | サブエージェント（Task tool） |
| 同一ファイルを複数が編集 | 上書き競合が発生する | 順次実行 |
| 順序依存タスク | 前タスクの結果が次に必要 | 順次実行 |
| 要件定義・設計フェーズ | ユーザー対話が中心 | 単一セッション |
| 結果のみ必要で議論不要 | メンバー間通信が不要 | サブエージェント（Task tool） |

**重要**: 上記に該当しない場合（3つ以上の独立タスク、異なるファイルセット、依存関係なし）は、エージェントチームを使用すること。

## トラブルシューティング

### メンバーが応答しない

Shift+Up/Down（in-processモード）またはペインクリック（split-paneモード）でメンバーの状態を確認。必要に応じて新しいメンバーをスポーン。

### ファイル競合が発生した

1. 競合したチームメンバーを停止
2. gitで競合を解消
3. 片方のメンバーに作業を再割り当て

### リーダーが先に作業を始めてしまう

```text
チームメンバーのタスク完了を待ってください。自分では実装しないでください。
```

### チームの後片付け

作業完了後は必ずリーダーにクリーンアップを指示:

```text
チームをクリーンアップしてください
```
