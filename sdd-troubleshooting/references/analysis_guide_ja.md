# トラブルシューティング分析ガイド

SDDトラブルシューティングスキルにおける分析プロセスの詳細ガイドです。

## 分析の原則

### 1. 事実に基づく分析

- 推測や仮定ではなく、確認された事実を基に分析
- コードの実際の動作を追跡
- ログやエラーメッセージを証拠として活用

### 2. 仕様との照合

- 要件定義（docs/requirements/）を参照
- 設計（docs/design/）を参照
- 仕様の意図を理解した上で乖離を判定

### 3. 承認プロセスの遵守

- 修正方針は必ずユーザー承認を得る
- 承認なしにタスク作成に進まない
- 承認内容を記録に残す

## 問題分類

### カテゴリ1: 実装バグ

仕様は正しいが、実装が仕様通りになっていない。

**特徴**:
- 仕様書に正しい振る舞いが記載されている
- コードが仕様と異なる動作をしている

**対応**:
- 仕様に合わせてコードを修正
- 修正後、仕様との一致を確認

**例**:
```
仕様: 「ユーザーがログインに失敗した場合、エラーメッセージを表示する」
実装: エラーメッセージが表示されない
→ コードのエラーハンドリングを修正
```

### カテゴリ2: 仕様バグ

仕様自体に問題がある。

**特徴**:
- 仕様通りに実装されている
- しかし仕様自体が間違っている/不適切

**対応**:
- 仕様の修正が必要
- 要件定義または設計の更新を伴う
- ユーザーとの合意が特に重要

**例**:
```
仕様: 「セッションは24時間で期限切れになる」
問題: ユーザーが長時間作業中にセッション切れで作業データを失う
→ 仕様自体を見直し（アクティブ時は延長等）
```

### カテゴリ3: 仕様漏れ

仕様に記載がないケース。

**特徴**:
- 仕様書に該当する記述がない
- 実装者の判断で実装されている
- または未実装

**対応**:
- 仕様の追加が必要
- 正しい振る舞いをユーザーと合意
- 要件定義と設計の両方を更新

**例**:
```
仕様: ファイルアップロード機能の記載のみ
問題: ファイルサイズ制限の挙動が未定義
→ サイズ制限の仕様を追加
```

## 原因分析テクニック

### 1. スタックトレース分析

エラーが発生している場合、スタックトレースから原因箇所を特定。

**手順**:
1. エラーメッセージを確認
2. スタックトレースの最上位（直接の原因）を確認
3. 呼び出し元を遡って根本原因を特定

### 2. バイナリサーチ

問題が発生する条件を絞り込む。

**手順**:
1. 問題が発生する状態と発生しない状態を特定
2. 中間の状態をテスト
3. 問題発生の境界を絞り込む

### 3. 差分分析

正常に動作していた時点からの変更を分析。

**手順**:
1. 正常動作していた時点を特定
2. その時点からの変更を確認（git diff等）
3. 問題を引き起こした変更を特定

### 4. コードフロー追跡

入力から出力までの処理フローを追跡。

**手順**:
1. 入力ポイントを特定
2. 処理の各ステップを追跡
3. 問題が発生するポイントを特定

## 影響範囲の評価

### 直接的な影響

修正対象のコードを直接使用している箇所。

**確認方法**:
- 関数/メソッドの呼び出し元を検索
- インポート/参照を確認
- テストコードを確認

### 間接的な影響

修正により副作用の生じる可能性がある箇所。

**確認方法**:
- 共有されるデータ構造を確認
- 状態管理の影響を確認
- 外部システムとの連携を確認

### 評価マトリクス

| 影響レベル | 説明 | 対応 |
|-----------|------|------|
| 高 | 複数の機能に影響 | 慎重なテスト、段階的リリース |
| 中 | 単一機能内で影響 | 該当機能の回帰テスト |
| 低 | 局所的な影響 | 修正箇所のテスト |

## 修正方針の策定

### アプローチの比較

複数の修正方法がある場合の比較観点。

| 観点 | 説明 |
|------|------|
| 実装の複雑さ | 修正の難易度 |
| リスク | 副作用やリグレッションのリスク |
| 保守性 | 将来の保守のしやすさ |
| 時間 | 実装に要する時間 |
| 仕様への適合 | 仕様との整合性 |

### 推奨アプローチの選定基準

1. **仕様との整合性が最優先**
2. リスクが低いアプローチを優先
3. 保守性を考慮
4. 時間と複雑さはトレードオフとして評価

## 承認プロセスの詳細

### 承認が必要な理由

1. **ユーザーの意図の確認**: 修正方針がユーザーの期待と一致するか
2. **影響範囲の認識**: ユーザーが影響範囲を理解しているか
3. **優先順位の決定**: 複数の修正方法がある場合の選択
4. **記録の明確化**: 何が承認されたかを明確にする

### 承認を求めるタイミング

```text
1. 問題事象の確認完了後 → 調査開始の承認（任意）
2. 根本原因の特定後 → 分析結果の確認（任意）
3. 修正方針の策定後 → 修正方針の承認（必須）★
4. タスク分割後 → タスク内容の確認（任意）
```

### 承認記録の形式

```markdown
## 承認記録

### 承認日時
[YYYY-MM-DD HH:MM]

### 承認者
[ユーザー名/識別子]

### 承認された修正方針
[修正方針の概要]

### 追加の条件・要望
[あれば記載]

### 備考
[その他の備考]
```

## タスク分割のガイドライン

### 分割の原則

1. **単一責務**: 1タスク1目的
2. **適切な粒度**: 20-40分程度で完了できる大きさ
3. **独立性**: 可能な限り並列実行可能に
4. **明確な完了条件**: テスト可能な受入基準

### タスクの順序付け

```text
1. 仕様更新タスク（仕様バグ/漏れの場合）
      ↓
2. 実装修正タスク
      ↓
3. テスト追加タスク
      ↓
4. 動作確認タスク
```

### タスク間の依存関係

依存関係は明示的に記載し、循環依存を避ける。

```markdown
| ID | タスク名 | 依存タスク |
|----|---------|-----------|
| TASK-101 | 要件定義の更新 | なし |
| TASK-102 | コンポーネント修正 | TASK-101 |
| TASK-103 | テスト追加 | TASK-102 |
```

## チェックリスト

### 問題事象確認のチェックリスト

- [ ] 現象が明確に把握できている
- [ ] 期待動作が明確である
- [ ] 再現手順が確立されている
- [ ] 発生環境が特定されている
- [ ] エラー情報が収集されている

### 原因分析のチェックリスト

- [ ] 関連するコードを調査した
- [ ] 原因箇所を特定した
- [ ] 原因のメカニズムを理解した
- [ ] 他に原因がないか確認した

### 仕様照合のチェックリスト

- [ ] 関連する要件定義を確認した
- [ ] 関連する設計を確認した
- [ ] 乖離の分類を行った
- [ ] 仕様更新の要否を判定した

### 修正方針策定のチェックリスト

- [ ] 修正アプローチを検討した
- [ ] 修正対象を特定した
- [ ] 影響範囲を評価した
- [ ] リスクを評価した
- [ ] テスト方針を策定した

### 承認プロセスのチェックリスト

- [ ] 修正方針をユーザーに提示した
- [ ] AskUserQuestionツールで承認を求めた
- [ ] 承認内容を記録した
- [ ] 追加の要望を反映した

### タスク分割のチェックリスト

- [ ] タスクが適切な粒度に分割されている
- [ ] 各タスクに受入基準がある
- [ ] 依存関係が明確である
- [ ] docs/tasks/に追加した
- [ ] index.mdを更新した
