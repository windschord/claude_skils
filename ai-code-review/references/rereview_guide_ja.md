# 再レビューガイド

修正後のPRを再レビューする際の手順と判定基準です。

## 再レビューの目的

1. **前回指摘の修正確認**: 指摘された問題が正しく修正されたかを検証する
2. **リグレッション検出**: 修正により新たな問題が発生していないかを確認する
3. **新規変更のレビュー**: 修正に伴う新しいコード変更を4観点でレビューする

## 再レビューの開始条件

以下のいずれかの場合に再レビューを実施する:

- ユーザーが「再レビューしてください」と明示的に依頼した場合
- ユーザーが「修正しました」「対応しました」等と報告した場合
- 同一PRに対して以前レビューを実施しており、新しいコミットが追加された場合

## ワークフロー

### フェーズ1: 前回レビュー情報の取得

```bash
# 前回のレビューコメントを取得
gh api repos/{owner}/{repo}/pulls/{PR番号}/reviews

# 前回のインラインコメントを取得
gh api repos/{owner}/{repo}/pulls/{PR番号}/comments

# 前回レビュー以降のコミット一覧を取得
gh api repos/{owner}/{repo}/pulls/{PR番号}/commits
```

前回のレビューコメントから以下を抽出する:
- 各指摘のID（F-001等）
- 対象ファイルと行番号
- 重大度（critical/warning/suggestion/nitpick）
- 指摘内容と推奨修正

### フェーズ2: 前回指摘の修正確認

各指摘について以下の手順で修正状況を確認する。

#### 確認手順

1. 指摘対象のファイル・行番号の最新状態を確認
2. 推奨された修正（または同等の修正）が適用されているか確認
3. 修正が元の指摘の意図を正しく反映しているか確認
4. 修正により新たな問題が発生していないか確認

#### 修正状態の判定基準

| 状態 | 判定基準 |
|------|----------|
| resolved | 指摘に対する修正が適切に行われている。推奨修正と完全一致でなくても、問題の本質が解決されていればresolved |
| partially-resolved | 修正はされているが不十分。例: 複数箇所の修正が必要だが一部のみ対応、修正方向は正しいが漏れがある |
| unresolved | 修正されていない。該当コードに変更がない、または変更が指摘と無関係 |
| wont-fix | PR作者がコメント等で修正しない判断を示している場合。理由が妥当かどうかを評価する |
| regressed | 修正により別の問題が発生した場合。元の問題は直ったが新たなバグ・脆弱性が生まれた |

#### wont-fixの評価

PR作者が修正しないと判断した場合、以下を確認する:

- 理由が技術的に妥当か
- リスクが許容範囲内か
- 代替策が提示されているか

理由が不十分な場合は、再度修正を要請する（状態はunresolvedとする）。

### フェーズ3: 新規変更のレビュー

前回レビュー以降に追加された変更について、通常の4観点レビューを実施する。

#### レビュー対象の特定

```bash
# 前回レビュー以降のdiffを取得
# 方法1: 前回レビュー時点のコミットSHAがわかる場合
gh api repos/{owner}/{repo}/compare/{前回SHA}...{最新SHA}

# 方法2: PR全体のdiffを取得して変更箇所を確認
gh pr diff <PR番号>
```

#### 特に注意する点

- 修正に伴い新たなセキュリティリスクが導入されていないか
- 修正範囲が適切か（過剰な変更、不要なリファクタリングが含まれていないか）
- テストが追加・更新されているか（必要な場合）
- ドキュメントの更新が必要な場合、更新されているか

### フェーズ4: 結果の統合と承認確認

#### 総合判定基準

| 判定 | 条件 |
|------|------|
| Approve | 前回指摘がすべてresolved/wont-fix（妥当）、かつ新規criticalなし |
| Request Changes | unresolved/regressedが1件以上、または新規critical/warningが1件以上 |
| Comment | 前回指摘はresolved、新規suggestionのみ |

#### ★ レビュー結果の承認確認（必須ゲート）

PRコメントを投稿する前に、以下の手順でユーザーの承認を得る:

1. レビューサマリーをユーザーに出力する（総合判定、前回指摘の修正状況、新規指摘の概要）
2. `AskUserQuestion`ツールで投稿の承認を確認する
3. ユーザーが承認した場合のみ、PRコメントを投稿する

**承認確認はApprove / Request Changes / Comment いずれの判定でも省略できない。**

詳細な手順はSKILL.mdのステップ5「レビュー結果の承認確認」を参照。

#### 投稿内容

ユーザーの承認後、以下を投稿する:

1. **サマリーコメント**: 再レビュー用テンプレートを使用
   - 前回指摘の修正状況表
   - 新規指摘のサマリー
   - 総合判定
2. **インラインコメント**:
   - 未修正/部分修正の指摘には修正確認コメント
   - 新規指摘は通常のインラインコメント

## 修正確認のコメント形式

### resolvedの場合

```markdown
**[resolved]** 前回指摘 F-001 の修正確認

修正を確認しました。[修正内容の簡潔な確認コメント]

<details>
<summary>AI向け指示</summary>

```json
{
  "finding_id": "F-001",
  "status": "resolved",
  "verification": "[確認した内容]"
}
```

</details>
```

### unresolvedの場合

```markdown
**[unresolved]** 前回指摘 F-002 が未修正です

前回指摘した問題が修正されていません。対応をお願いします。

<details>
<summary>AI向け指示</summary>

```json
{
  "finding_id": "F-002",
  "status": "unresolved",
  "original_issue": "[元の問題]",
  "fix": {
    "old_text": "[現在のコードテキスト]",
    "new_text": "[修正後のコードテキスト]"
  },
  "context": "[該当行の前後3行程度のコード断片]",
  "scope": "fix-in-this-pr | fix-in-follow-up"
}
```

</details>
```

### regressedの場合

```markdown
**[regressed]** 前回指摘 F-003 の修正によりリグレッションが発生

前回の問題は修正されましたが、その修正により新たな問題が発生しています。

<details>
<summary>AI向け指示</summary>

```json
{
  "finding_id": "F-003",
  "status": "regressed",
  "original_issue": "[元の問題]",
  "regression": "[リグレッションの説明]",
  "fix": {
    "old_text": "[現在のコード（リグレッションを含む）]",
    "new_text": "[正しい修正後のコード]"
  },
  "context": "[該当行の前後3行程度のコード断片]",
  "scope": "fix-in-this-pr"
}
```

</details>
```

## 複数回の再レビュー

同一PRに対して3回以上のレビューが発生する場合:

- 前回（直近）のレビュー指摘だけでなく、過去すべてのレビュー指摘の状態を追跡する
- 指摘IDは通し番号で管理（F-001, F-002, ... 初回 / F-101, F-102, ... 2回目 / F-201, F-202, ... 3回目）
- 長期間unresolvedの指摘がある場合、その理由を確認する
