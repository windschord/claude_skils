# レビューガイドライン

6つのレビュー観点それぞれの詳細なチェック項目と判断基準です。

## 観点1: セキュリティ

### チェック項目

#### 認証・認可

- 認証チェックをバイパス可能な経路がないか
- 認可（権限チェック）が適切に実装されているか
- トークン・セッション管理に問題がないか
- パスワード・秘密鍵がハードコードされていないか

#### 入力検証

- ユーザー入力がサニタイズされているか
- SQLインジェクションの防止（パラメータ化クエリの使用）
- XSS（クロスサイトスクリプティング）の防止
- コマンドインジェクションの防止
- パストラバーサルの防止
- SSRF（サーバーサイドリクエストフォージェリ）の防止

#### データ保護

- 機密データが適切に暗号化されているか
- ログに機密情報が出力されていないか
- エラーメッセージに内部情報が漏洩していないか
- `.env`、秘密鍵、APIキーがコミットされていないか

#### 依存関係

- 依存関係のバージョンが固定されているか（lockfileの確認）
- 不審な依存関係やtyposquattingの疑いのあるパッケージを含んでいないか

> **注**: 既知のCVEを持つパッケージの具体的なバージョンチェックは[観点6: 既知脆弱性の検出](#観点6-既知脆弱性の検出)で実施する。

#### 暗号化

- 古い・脆弱なアルゴリズム（MD5、SHA1、DES等）が使用されていないか
- 暗号学的に安全な乱数生成器が使用されているか
- TLS/SSL設定が適切か

### 重大度の判定基準

| 重大度 | 条件 |
|--------|------|
| critical | 外部からの攻撃で悪用可能な脆弱性 |
| critical | 機密データの漏洩リスク |
| warning | 防御層が不足している（多層防御の観点） |
| warning | ベストプラクティスからの逸脱 |
| suggestion | セキュリティをさらに強化できる提案 |

## 観点2: ドキュメントとの乖離

### チェック項目

#### API仕様との整合性

- エンドポイントのパス、HTTPメソッドが仕様と一致しているか
- リクエスト/レスポンスのスキーマが仕様と一致しているか
- エラーコード・エラーメッセージが仕様と一致しているか
- 認証方式が仕様と一致しているか

#### README / 使い方ガイドとの整合性

- 新機能がREADMEに記載されているか（または記載が必要か）
- 環境変数・設定項目の追加がドキュメント化されているか
- 動作要件（最低バージョン等）の変更が反映されているか

#### コードコメントとの整合性

- 関数のdocstring/JSDocと実際の挙動が一致しているか
- TODOコメントが残っていないか（または意図的なものか）
- 廃止予定（deprecated）マークが適切か

#### 設計ドキュメントとの整合性（SDDプロジェクトの場合）

- `docs/sdd/requirements/` の要件と実装が一致しているか
- `docs/sdd/design/` の設計と実装が一致しているか
- データベーススキーマの変更が設計書に反映されているか

#### ステータス値・列挙値の妥当性

不整合を指摘する際は、使用されている値が**そもそもフレームワークで定義された正当な値かどうか**を確認する。

- ステータス値（例: TODO, IN_PROGRESS, DONE, SKIP等）が定義元（テンプレート、index.md、enum等）に存在するか確認
- 定義にない値が使われている場合、値自体の不正を指摘に含める（「SKIPステータスと受入基準の矛盾」だけでなく「SKIP自体が未定義のステータス値」も指摘）
- 確認先の例: タスクテンプレート、index.md、SDDフレームワーク定義、コードのenum/const定義

### 重大度の判定基準

| 重大度 | 条件 | カテゴリ |
|--------|------|---------|
| critical | API仕様と実装が矛盾し、クライアントが動作しない | docs-drift |
| warning | ドキュメントと実装の不一致（動作には影響しないが誤解を招く） | docs-drift |
| warning | 同一ファイル内のステータスと受入基準等の論理矛盾 | internal-consistency |
| warning | 記載された数値・事実が実態と不一致 | internal-consistency |
| suggestion | ドキュメントの追加・更新が望ましい | docs-drift |
| nitpick | コメントの誤字・表現の改善 | `docs-drift` または `internal-consistency` |

## 観点3: 可読性・複雑度

### チェック項目

#### 命名

- 変数名・関数名・クラス名が意図を正確に伝えているか
- プロジェクトの命名規則に従っているか
- 略語の使用が適切か（一般的でない略語は避ける）
- boolean変数が`is`/`has`/`can`等の接頭辞で始まっているか

#### 関数設計

- 1つの関数が1つの責務に集中しているか（SRP）
- 関数の引数が多すぎないか（目安: 4つ以下）
- 副作用が明確か（または副作用がないか）
- 早期リターンで条件分岐が整理されているか

#### 複雑度

- ネストの深さが適切か（目安: 3段以下）
- 循環的複雑度が高すぎないか（目安: 10以下）
- 条件式が複雑すぎないか（名前付き変数や関数に抽出すべきか）

#### コード重複

- 同一・類似のコードブロックが複数箇所に存在しないか
- 共通処理の抽出が適切に行われているか

#### エラーハンドリング

- エラーケースが適切に処理されているか
- エラーの握りつぶし（空のcatch等）がないか
- エラーメッセージがデバッグに有用か

### 重大度の判定基準

| 重大度 | 条件 |
|--------|------|
| warning | 循環的複雑度が15以上、または深いネスト（4段以上） |
| warning | 明らかなバグにつながる可読性の問題 |
| suggestion | リファクタリングで改善可能な構造 |
| nitpick | 命名やスタイルの軽微な改善 |

## 観点4: ライブラリ選定の妥当性

### チェック項目

#### 新規ライブラリの追加時

- **目的の妥当性**: そのライブラリが本当に必要か（標準ライブラリで代替可能ではないか）
- **メンテナンス状況**: 最終更新日、コミット頻度、未解決Issue数
- **コミュニティ**: スター数、ダウンロード数、コントリビューター数
- **ライセンス**: プロジェクトのライセンスと互換性があるか
- **セキュリティ対応姿勢**: セキュリティアドバイザリへの対応速度、過去の脆弱性対応履歴（※具体的なCVEチェックは[観点6](#観点6-既知脆弱性の検出)で実施）
- **サイズ**: バンドルサイズへの影響（フロントエンドの場合は特に重要）
- **代替手段**: より軽量・安全・広く使われている代替ライブラリがないか

#### 既存ライブラリのバージョン変更時

- **Breaking Changes**: メジャーバージョンアップの場合、Breaking Changesが確認されているか
- **CHANGELOG確認**: セキュリティ修正が含まれているか
- **互換性**: 他の依存関係との互換性が保たれているか

#### 依存関係全般

- lockfile（package-lock.json, yarn.lock, Gemfile.lock等）が適切に更新されているか
- 不要な依存関係が追加されていないか
- devDependenciesとdependenciesの区別が正しいか

### 重大度の判定基準

| 重大度 | 条件 |
|--------|------|
| critical | ライセンス非互換（GPL汚染等） |
| warning | メンテナンスされていないライブラリ（1年以上更新なし） |
| warning | 標準ライブラリで代替可能な外部依存 |
| suggestion | より良い代替ライブラリの提案 |
| nitpick | バージョン固定の推奨 |

## 観点5: PR説明の適切性

### チェック項目

#### PRタイトルの適切性

- PRタイトルが変更内容を正確かつ簡潔に表現しているか
- タイトルが曖昧すぎないか（例: 「修正」「更新」「対応」だけでは不十分）
- タイトルがdiffの実際の変更範囲と一致しているか（タイトルではA機能の変更を謳っているが実際にはB機能も変更している等）
- プロジェクトのPRタイトル命名規則（Conventional Commits等）に従っているか

#### PR説明文の適切性

- 変更の目的・背景（Why）が説明されているか
- 変更の概要（What）が実際のdiffと一致しているか
- 説明文に記載された変更内容が過不足なく実際の変更を反映しているか
- 説明文で言及されているファイルや機能が実際に変更されているか（逆も確認）
- 関連するIssue番号やチケットへのリンクがあるか（プロジェクトで必要な場合）

#### レビュアー向け情報の充実度

- テスト方法や動作確認手順が記載されているか（必要な場合）
- Breaking Changesがある場合、明記されているか
- マイグレーション手順が必要な場合、記載されているか
- スクリーンショットやGIF等が添付されているか（UI変更の場合）

### 重大度の判定基準

| 重大度 | 条件 |
|--------|------|
| warning | PRタイトル・説明文が実際の変更内容と矛盾している（レビュアーが変更を誤解する可能性がある） |
| warning | 重要な変更（Breaking Changes、セキュリティ修正等）が説明文に記載されていない |
| suggestion | 説明文が不十分で、レビュアーがdiffだけでは変更の意図を理解しにくい |
| suggestion | テスト手順や動作確認方法の追記が望ましい |
| nitpick | タイトルの表現改善、説明文のフォーマット改善 |

## 観点6: 既知脆弱性の検出

### チェック項目

#### 依存パッケージの脆弱性スキャン

- 追加・更新されたパッケージに既知のCVE（Common Vulnerabilities and Exposures）が報告されていないか
- lockfileに含まれる間接依存（transitive dependencies）にも脆弱性がないか
- 脆弱性の重大度（Critical, High, Medium, Low）を確認する

#### 脆弱性情報の確認方法

```bash
# npm プロジェクトの場合
npm audit --json

# yarn プロジェクトの場合
yarn audit --json

# pnpm プロジェクトの場合
pnpm audit --json

# Python プロジェクトの場合（pip-auditがインストール済みの場合）
pip-audit --format=json

# Ruby プロジェクトの場合（bundler-auditがインストール済みの場合）
bundle-audit check

# Go プロジェクトの場合
govulncheck ./...

# GitHub Advisory Databaseでの確認
gh api graphql -f query='{ securityVulnerabilities(first: 5, ecosystem: NPM, package: "パッケージ名") { nodes { advisory { summary severity publishedAt } vulnerableVersionRange firstPatchedVersion { identifier } } } }'
```

#### 既存依存関係のバージョン確認

- PRで直接変更されていなくても、lockfileの更新に伴い脆弱なバージョンに固定されていないか
- 既に脆弱性が報告されているバージョンを使い続けていないか（特にPRで依存関係ファイルが変更されている場合）
- パッチが公開されている脆弱性に対して、アップデートが可能か

#### セキュリティアドバイザリの確認

- GitHub Security Advisories（GHSA）で報告された脆弱性がないか
- NVD（National Vulnerability Database）に登録されたCVEがないか
- 使用パッケージのリポジトリにセキュリティに関するIssue/PRが報告されていないか

### 重大度の判定基準

| 重大度 | 条件 |
|--------|------|
| critical | CVSS スコア 9.0以上（Critical）の脆弱性を持つバージョンを使用。パッチ済みバージョンが存在する |
| critical | リモートコード実行（RCE）、認証バイパス等の深刻な脆弱性が報告されたバージョンを使用 |
| warning | CVSS スコア 7.0〜8.9（High）の脆弱性。パッチ済みバージョンが存在する |
| warning | 脆弱性が報告されているがパッチ未公開。回避策（workaround）が存在する |
| suggestion | CVSS スコア 4.0〜6.9（Medium）の脆弱性。影響範囲が限定的 |
| suggestion | 脆弱性が報告されているがプロジェクトの利用形態では影響を受けない可能性が高い |
| nitpick | CVSS スコア 3.9以下（Low）の脆弱性。実質的なリスクが極めて低い |

## 根拠の裏取り（必須）

指摘に数値や事実を含める場合、**必ずソースを確認してから記載する**。裏取りなしの断定はレビューの信頼性を損なう。

### 裏取りが必要なケース

| ケース | 正しい対応 | NG例 |
|--------|-----------|------|
| テスト数の言及 | 実際にテストファイルを確認し、テスト関数をカウント | 「全体で243件のテスト」と未確認で断定 |
| パフォーマンス数値 | ベンチマーク結果やプロファイル結果を参照 | 「3倍遅くなる」と根拠なく主張 |
| ステータス値の妥当性 | 定義元（テンプレート、index.md、enum定義等）を確認 | 定義に存在するか確認せず指摘 |
| 「全体」「すべて」の表現 | 対象範囲を特定してから使用 | 範囲が曖昧なまま「全テスト」と表現 |

### 裏取りの手順

1. 指摘に含める数値・事実をリストアップする
2. 各項目のソースを特定する（ファイル、コマンド出力、ドキュメント等）
3. ソースを実際に確認する
4. 確認できない場合は「〜の可能性がある」「要確認」等の表現を使う

## レビューの進め方

### 1. まず全体像を把握する

- PR説明文を読む
- 変更ファイル一覧を確認し、変更の全体像を理解する
- 変更の目的・背景を把握する

### 2. 優先度順にレビューする

1. セキュリティ関連の変更（認証、入力処理、データ操作）
2. APIやデータベースの変更
3. ビジネスロジックの変更
4. 設定・インフラの変更
5. テスト・ドキュメントの変更

### 3. 指摘の質を重視する

- 1つの指摘に集中し、根拠を明確にする
- 「こうすべき」だけでなく「なぜそうすべきか」を説明する
- 可能な限り具体的な修正コードを提示する
- 些細な指摘で重大な指摘が埋もれないようにする

## gh CLIでの情報収集コマンド集

```bash
# PR差分の取得
gh pr diff <PR番号>

# PR詳細の取得（タイトル、説明、ラベル等）
gh pr view <PR番号>

# 変更ファイル一覧
gh pr diff <PR番号> --name-only

# PR内のファイル内容を確認（特定ファイル）
gh pr diff <PR番号> -- path/to/file

# PRのチェック状況（CI結果等）
gh pr checks <PR番号>

# PRのコメント一覧
gh api repos/{owner}/{repo}/pulls/{PR番号}/comments

# PRのレビュー一覧
gh api repos/{owner}/{repo}/pulls/{PR番号}/reviews

# ライブラリ情報の確認（npm）
npm view <パッケージ名> --json

# ライブラリの脆弱性チェック（npm）
npm audit --json
```
