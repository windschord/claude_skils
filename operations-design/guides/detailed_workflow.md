# 詳細ワークフロー - ステップ2-5の実装ガイド

このドキュメントは、運用設計スキルのステップ2-5の詳細な実装手順を記載しています。

**対象読者**: Claude Code（AI）

**目的**: セクションごとの反復的アプローチで、推論を避けながら運用設計書を作成する

---

#### ステップ2: テンプレート構造の提示（最終形の提示）

**【重要】全体像を先に見せることで、ユーザーに運用設計書の完成形をイメージしてもらう**

```
コンサルタント: 業界トレンド調査が完了しました。

                次に、運用設計書の全体構造をご説明します。
                運用設計書は以下のセクションで構成されています。

                [Readツールで選択されたテンプレートのモジュール一覧を表示]

                **運用設計書の構成**:

                【必須セクション】（すべてのプロジェクトで必要）
                ✅ 1. 概要
                   - サービスの目的と対象範囲
                   - 前提条件と制約条件
                   - クラウドネイティブ特有の考慮事項

                ✅ 2. サービス概要
                   - サービスの目的と機能
                   - システム構成
                   - 外部連携

                ✅ 3. 運用方針と目標（SLO/SLI/SLA）
                   - サービスレベル目標
                   - 監視指標
                   - エラーバジェット

                ✅ 4. 運用体制
                   - 組織体制とRACIマトリクス
                   - 運用時間帯とオンコール体制
                   - コミュニケーション方法

                ✅ 5. 運用スケジュール
                   - 定期運用スケジュール
                   - メンテナンスウィンドウ

                ✅ 6. 定常運用作業
                   - 日次・週次・月次の運用作業

                ✅ 7. 監視・通知
                   - 監視方針と監視項目
                   - ログ管理とアラート通知

                ✅ 8. インシデント管理
                   - インシデント定義と対応フロー
                   - エスカレーションパス

                ✅ 9. 変更管理
                   - 変更管理方針とフロー
                   - ロールバック計画

                ✅ 10. リリース管理
                   - リリース方針とスケジュール
                   - デプロイメント戦略

                ✅ 11. バックアップ・リカバリ
                   - バックアップ方針と設計
                   - DR計画

                【推奨セクション】（セキュリティ要件がある場合）
                ⭐ 12. セキュリティ運用
                   - アクセス管理と脆弱性管理
                   - DevSecOps（CI/CDセキュリティ）

                【オプションセクション】（高度な運用が必要な場合）
                📚 13. キャパシティ管理
                📚 14. コスト管理とFinOps
                📚 15. レジリエンステストとChaos Engineering（99.99%以上のSLA要件がある場合のみ）
                📚 16. 問題管理
                📚 17. ナレッジ管理
                📚 18. 継続的改善
                📚 19. 付録

                ---

                貴社のプロジェクト規模と要件に基づき、以下のセクションを作成することを推奨します：

                [プロジェクト規模に応じた推奨セクションを提示]
                - 小規模プロジェクト: セクション1-11
                - 中規模プロジェクト: セクション1-12
                - 大規模プロジェクト: セクション1-14 + 選択的にセクション15-19

                これから、各セクションを順番に作成していきます。
                各セクションごとに、必要な情報をヒアリングし、作成し、確認いただきます。

                それでは、セクション1「概要」から始めます。
```

**会話ログへの記録内容**:
```markdown
### [HH:MM] テンプレート構造の提示

**選択されたテンプレート**: [operations_design_template_XXX_ja.md]

**作成対象セクション**:
- 必須: セクション1-11
- 推奨: セクション12（セキュリティ要件がある場合）
- オプション: セクション13-19（プロジェクト規模に応じて）

**記録事項**:
- プロジェクト規模に応じた推奨セクション: [リスト]
- 次のアクション: セクション1「概要」のヒアリング開始
```

#### ステップ3: セクションごとの反復（for each section）

**【重要】各セクションで「ヒアリング → 作成 → 確認 → 承認」のサイクルを繰り返す**

**セクションごとの作業フロー**:

```
┌─────────────────────────────────────────────────┐
│ for each section in [推奨セクションリスト]:      │
│                                                 │
│   3.1. このセクションに必要な情報をヒアリング    │
│   3.2. このセクションのみ作成                   │
│   3.3. ユーザーに確認・承認                     │
│   3.4. 次のセクションへ                         │
└─────────────────────────────────────────────────┘
```

---

### 3.1-3.4: セクション1「概要」の作成

**3.1. ヒアリング**:

```
コンサルタント: （AskUserQuestionツールを使用）
                セクション1「概要」を作成するため、以下の情報を教えてください。

                Q1: 運用設計書の目的は何ですか？
                    - 新規サービスの運用開始
                    - 既存サービスの運用改善
                    - クラウド移行に伴う運用再設計
                    - その他

                Q2: 対象範囲を教えてください
                    - システム名・サービス名
                    - 対象業務
                    - 運用開始予定日
                    - 運用終了予定日（該当する場合）

                Q3: 前提条件はありますか？
                    - システム開発の完了状況
                    - 運用環境の構築状況
                    - 運用チームの準備状況
                    - その他

                Q4: 制約条件はありますか？
                    - 予算制約
                    - リソース制約（人員・インフラ）
                    - 技術制約
                    - 法規制・コンプライアンス

ユーザー: [回答]

コンサルタント: ありがとうございます。
                [Editツールで会話ログに質問と回答を記録]
```

**3.2. セクション作成**:

```
コンサルタント: いただいた情報を基に、セクション1「概要」を作成します。

                [Writeツールで運用設計書ファイルを作成し、セクション1を記載]

                セクション1を作成しました。
```

**3.3. ユーザー確認・承認**:

```
コンサルタント: セクション1「概要」の内容をご確認ください。

                [作成したセクション1の内容を提示]

                修正が必要な箇所はありますか？

ユーザー: [承認/修正依頼]

コンサルタント: [修正が必要な場合はEditツールで修正]

                承認いただき、ありがとうございます。
                [Editツールで会話ログに承認状況を記録]
```

**3.4. 次のセクションへ**:

```
コンサルタント: セクション1が承認されました。
                次に、セクション2「サービス概要」に進みます。
```

---

### 3.1-3.4: セクション2「サービス概要」の作成

**3.1. ヒアリング**:

```
コンサルタント: （AskUserQuestionツールを使用）
                セクション2「サービス概要」を作成するため、以下の情報を教えてください。

                【サービスの目的】
                Q1: サービスが提供する価値は何ですか？
                    - ビジネス目的
                    - ユーザーに提供する価値

                【サービスの機能】
                Q2: 主要な機能を教えてください
                    - 機能名と概要
                    - 各機能の重要度（High/Medium/Low）

                【システム構成】
                Q3: システムのアーキテクチャを教えてください
                    - 主要コンポーネント（フロントエンド、バックエンド、DB等）
                    - 使用技術スタック
                    - 冗長化構成

                Q4: アーキテクチャ図はありますか？
                    - ある場合: 共有してください
                    - ない場合: 口頭で説明してください

                【外部連携】
                Q5: 外部システムとの連携はありますか？
                    - 連携先システム名
                    - 連携方式（API/Batch等）
                    - データフロー（方向と内容）
                    - 重要度

ユーザー: [回答]
```

**3.2. セクション作成**:
**3.3. ユーザー確認・承認**:
**3.4. 次のセクションへ**:

[セクション1と同様のフロー]

---

### 3.1-3.4: セクション3「運用方針と目標（SLO/SLI/SLA）」の作成

**3.1. ヒアリング**:

```
コンサルタント: （AskUserQuestionツールを使用）
                セクション3「運用方針と目標」を作成するため、以下の情報を教えてください。

                【運用基本方針】
                Q1: 運用における優先事項は何ですか？
                    1位: [可用性重視/セキュリティ優先/継続的改善/コスト最適化]
                    2位: [...]
                    3位: [...]

                【サービスレベル目標（SLO）】
                Q2: 可用性目標は？
                    A) 99.9%（月間ダウンタイム約43分）
                    B) 99.95%（月間ダウンタイム約22分）
                    C) 99.99%（月間ダウンタイム約4分）
                    D) その他

                Q3: レスポンスタイム目標は？（Web同期リクエスト）
                    - P95レスポンスタイム: [XXX]ms以下
                    - P99レスポンスタイム: [XXX]ms以下

                Q4: エラーレート目標は？
                    - エラーレート: [X.X]%以下

                Q5: バッチ処理完了時刻の要件は？（該当する場合）
                    - 完了時刻: 翌朝[XX]時まで

                【サービスレベル合意（SLA）】
                Q6: 顧客に保証する品質基準は？
                    - SLA対象項目
                    - 保証値
                    - 測定期間（月次/四半期）
                    - 未達時の対応

ユーザー: [回答]
```

**3.2. セクション作成**:
**3.3. ユーザー確認・承認**:
**3.4. 次のセクションへ**:

[同様のフロー]

---

### 3.1-3.4: セクション4「運用体制」の作成

**3.1. ヒアリング**:

```
コンサルタント: （AskUserQuestionツールを使用）
                セクション4「運用体制」を作成するため、以下の情報を教えてください。

                【運用組織体制】
                Q1: 運用チームの構成は？
                    - 運用マネージャー: [人数]名
                    - 運用チーム: [チーム数]チーム、[人数]名
                    - SREチーム: [人数]名（該当する場合）
                    - その他

                【役割と責任（RACI）】
                Q2: 主要な運用プロセスにおける役割は？

                    プロセス: 監視・アラート対応
                    - Responsible（実行責任）: [役割]
                    - Accountable（説明責任）: [役割]
                    - Consulted（相談）: [役割]
                    - Informed（報告）: [役割]

                    プロセス: インシデント対応
                    - [同様に確認]

                    プロセス: 変更管理
                    - [同様に確認]

                    プロセス: リリース管理
                    - [同様に確認]

                【運用時間帯】
                Q3: 運用体制の時間帯は？
                    - 平日9:00-18:00: [通常体制/オンコール体制]
                    - 平日18:00-9:00: [オンコール体制/無人]
                    - 休日・祝日: [オンコール体制/無人]

                Q4: オンコール体制の詳細は？
                    - 1次対応担当: [担当者・連絡先]
                    - 2次対応担当: [担当者・連絡先]
                    - エスカレーション先: [担当者・連絡先]

                【コミュニケーション】
                Q5: 定例会議の設定は？
                    - 日次運用会議: [頻度・参加者・目的]
                    - 週次運用レビュー: [頻度・参加者・目的]
                    - 月次運用報告: [頻度・参加者・目的]

                Q6: 使用するコミュニケーションツールは？
                    - チャット: [ツール名・チャンネル]
                    - チケット管理: [ツール名]
                    - ドキュメント共有: [ツール名]
                    - インシデント管理: [ツール名]

ユーザー: [回答]
```

**3.2. セクション作成**:
**3.3. ユーザー確認・承認**:
**3.4. 次のセクションへ**:

[同様のフロー]

---

### 以降のセクション（5-19）も同様のフローで作成

**各セクションで必ずヒアリングする項目**:

**セクション5「運用スケジュール」**:
- 定期運用スケジュール（日次・週次・月次）
- メンテナンスウィンドウ
- 年間運用カレンダー

**セクション6「定常運用作業」**:
- 日次運用作業の内容と手順
- 週次運用作業の内容と手順
- 月次運用作業の内容と手順

**セクション7「監視・通知」**:
- 監視方針（ユーザー体験起点）
- 監視項目（優先度1: 外形監視、優先度2: アプリ監視、優先度3: インフラ監視）
- ログ管理
- アラート通知

**セクション8「インシデント管理」**:
- インシデント定義と分類（P1/P2/P3/P4）
- インシデント対応フロー
- エスカレーションパス

**セクション9「変更管理」**:
- 変更管理方針
- 変更分類（標準/通常/緊急/重要）
- 変更管理フロー
- ロールバック計画

**セクション10「リリース管理」**:
- リリース方針
- リリーススケジュール
- デプロイメント戦略（Blue-Green/Rolling/Canary）

**セクション11「バックアップ・リカバリ」**:
- バックアップ方針
- バックアップ設計（対象・方式・頻度）
- リカバリ設計（RPO/RTO）
- DR計画

**セクション12「セキュリティ運用」**（推奨）:
- セキュリティ運用方針
- アクセス管理
- 脆弱性管理
- DevSecOps（CI/CDセキュリティ）

**セクション13-19「高度な運用手法」**（オプション）:
- キャパシティ管理
- コスト管理とFinOps
- Chaos Engineering（99.99%以上のSLA要件がある場合のみ）
- 問題管理
- ナレッジ管理
- 継続的改善
- 付録

---

**会話ログへの記録（各セクション完了時）**:
```markdown
### [HH:MM] セクション[X]「[セクション名]」完了

**ヒアリング内容**:
- Q1: [質問] → A1: [回答]
- Q2: [質問] → A2: [回答]
- ...

**作成内容**:
- [セクションの概要]

**承認状況**: 承認済み

**次のアクション**: セクション[X+1]「[次のセクション名]」のヒアリング開始
```

---

**全セクション完了後**:

```
コンサルタント: すべてのセクションの作成が完了しました。

                これから、運用設計書全体の一貫性をチェックし、
                矛盾があれば自動的に修正します。
```

#### ステップ4: AI自身による一貫性チェックと自動修正

**【重要】ユーザーに質問するのではなく、AI自身が矛盾を検出して論理的に修正する**

全セクション完成後、AI自身が運用設計書の一貫性をチェックし、矛盾があれば自動的に修正します。

```
コンサルタント: すべてのセクションの作成が完了しました。

                これから、運用設計書全体の一貫性をチェックし、
                矛盾があれば自動的に修正します。

                【一貫性チェック実施中...】

                [AIが以下の観点で設計書全体を分析]

                1. SLO/SLI/SLAの整合性チェック
                   - SLOが測定可能なSLIで定義されているか
                   - SLAがSLOと整合しているか
                   - エラーバジェットが適切に設定されているか

                2. 運用体制と作業内容の整合性チェック
                   - 定義された作業に対して担当者が割り当てられているか
                   - 運用時間帯と作業スケジュールが矛盾していないか
                   - オンコール体制が適切に設計されているか

                3. 監視とインシデント対応の整合性チェック
                   - 監視項目とアラートレベルが定義されているか
                   - インシデント分類と対応時間が整合しているか
                   - エスカレーションパスが明確か

                4. 変更管理とリリース管理の整合性チェック
                   - 変更分類とリリース種別が整合しているか
                   - 承認プロセスが適切に設計されているか
                   - ロールバック計画が各変更種別に対応しているか

                ---

                【一貫性チェック完了】

                以下の矛盾を検出しました：

                1. ❌ SLO/SLI/SLAの矛盾
                   検出: セクション3（SLO: 可用性99.9%）とセクション8（インシデント対応時間: 15分以内）が矛盾
                   分析: 99.9%の可用性（月間ダウンタイム43分）では、15分の対応時間では不十分
                   修正: インシデント対応時間を30分以内に調整（99.9%のSLOに整合）

                   [Editツールで自動修正]

                2. ❌ 運用体制と作業内容の矛盾
                   検出: セクション4（運用時間: 平日9-18時）とセクション3（サービス提供: 24/365）が矛盾
                   分析: 24時間365日サービスを提供するには、24時間対応可能な運用体制が必要
                   修正: セクション4にオンコール体制（夜間・休日）を追加

                   [Editツールで自動修正]

                3. ❌ 監視項目の不足
                   検出: セクション7（監視項目）にセクション3（SLO: レスポンスタイムP95 500ms以下）に対応する監視項目が不足
                   分析: SLOを測定するためのSLI（監視項目）が必要
                   修正: セクション7に「レスポンスタイムP95」の監視項目とアラート閾値（500ms超でWarning、1000ms超でCritical）を追加

                   [Editツールで自動修正]

                4. ❌ 変更管理とリリーススケジュールの矛盾
                   検出: セクション9（変更管理リードタイム: 3営業日）とセクション10（リリーススケジュール: 週次）が矛盾
                   分析: 週次リリースを実現するには、3営業日のリードタイムでは間に合わない可能性がある
                   修正: セクション9の標準変更を「手順化済みの変更は即時承認可能」に調整し、週次リリースを実現可能にする

                   [Editツールで自動修正]

                5. ❌ バックアップRPOとSLO要件の矛盾
                   検出: セクション11（バックアップRPO: 6時間）とセクション3（SLO: データ損失許容なし）が矛盾
                   分析: RPO 6時間では、最大6時間分のデータ損失が発生する可能性があるため、「データ損失許容なし」とは矛盾
                   修正: セクション3のSLO記載を「データ損失は最小限に抑える（RPO: 6時間以内）」に修正し、整合性を取る

                   [Editツールで自動修正]

                ---

                【自動修正完了】

                以下の5件の矛盾を自動的に修正しました：

                ✅ 修正1: インシデント対応時間を15分→30分に調整（SLO 99.9%に整合）
                ✅ 修正2: オンコール体制を追加（24/365サービス提供に対応）
                ✅ 修正3: レスポンスタイムP95の監視項目とアラート閾値を追加（SLO測定のため）
                ✅ 修正4: 標準変更の承認プロセスを簡素化（週次リリースを実現）
                ✅ 修正5: SLOのデータ損失要件を調整（RPO 6時間と整合）

                修正内容を運用設計書に反映しました。
                [Editツールで会話ログに修正内容を記録]
```

**会話ログへの記録内容**:
```markdown
### [HH:MM] 一貫性チェックと自動修正

**検出された矛盾**: 5件

**自動修正内容**:
1. インシデント対応時間: 15分→30分（SLO 99.9%に整合）
2. オンコール体制追加: 夜間・休日対応体制を追加
3. 監視項目追加: レスポンスタイムP95の監視とアラート
4. 変更管理調整: 標準変更の承認プロセス簡素化
5. SLO調整: データ損失要件をRPO 6時間に整合

**記録事項**:
- 一貫性チェック実施日時: [YYYY-MM-DD HH:MM]
- 検出された矛盾数: 5件
- 自動修正数: 5件
- 次のアクション: ユーザーの最終承認
```

---

#### ステップ5: ユーザーの最終承認

**【重要】自動修正後の運用設計書をユーザーに提示し、最終承認を得る**

```
コンサルタント: 一貫性チェックと自動修正が完了しました。
                運用設計書の最終版をご確認ください。

                【運用設計書 最終版】

                **概要**:
                - サービス名: [サービス名]
                - インフラパターン: [クラウドネイティブ/クラウドインスタンス/オンプレミス]
                - 作成日: [YYYY-MM-DD]

                **主要な運用指標**:
                - SLO可用性: [XX.X]%
                - SLO レスポンスタイム（P95）: [XXX]ms以下
                - SLO エラーレート: [X.X]%以下
                - SLA: [内容]

                **運用体制**:
                - 運用チーム: [XX]名
                - 運用時間: [24/365 / 平日のみ / 営業時間のみ]
                - オンコール体制: [有/無]

                **主要な運用プロセス**:
                - 監視項目数: [XX]項目
                - インシデント対応目標時間: P1=[XX]分、P2=[XX]分、P3=[XX]時間、P4=[営業時間内]
                - リリース頻度: [週次/月次/四半期]
                - バックアップRPO/RTO: RPO=[XX]時間、RTO=[XX]時間

                **作成されたセクション**:
                ✅ セクション1: 概要
                ✅ セクション2: サービス概要
                ✅ セクション3: 運用方針と目標（SLO/SLI/SLA）
                ✅ セクション4: 運用体制
                ✅ セクション5: 運用スケジュール
                ✅ セクション6: 定常運用作業
                ✅ セクション7: 監視・通知
                ✅ セクション8: インシデント管理
                ✅ セクション9: 変更管理
                ✅ セクション10: リリース管理
                ✅ セクション11: バックアップ・リカバリ
                [✅ セクション12-19: 該当する場合]

                **自動修正の内容**:
                - [修正内容のサマリー]

                この内容で問題なければ、最終版として保存します。
                修正が必要な箇所があれば教えてください。

ユーザー: [承認/修正依頼]

コンサルタント: [承認の場合]
                ありがとうございます。
                運用設計書を最終版として保存しました。

                【保存ファイル】:
                - ファイル名: [YYYY-MM-DD]-[サービス名]-operations-design.md
                - 保存場所: [保存先パス]
                - ページ数: [XX]ページ
                - 作成日時: [YYYY-MM-DD HH:MM]

                [Writeツールで最終版を保存]
                [Editツールで会話ログに最終決定事項とサマリーを記録]

                ---

                【運用設計セッション完了】

                運用設計書の作成が完了しました。

                **作成内容のサマリー**:
                - セッション開始: [YYYY-MM-DD HH:MM]
                - セッション終了: [YYYY-MM-DD HH:MM]
                - 所要時間: [XX]時間
                - ヒアリング回数: [XX]回
                - 作成セクション数: [XX]セクション
                - 検出・修正した矛盾: [XX]件

                **次のステップ**:
                1. 運用設計書を関係者にレビュー依頼
                2. 承認プロセスを経て正式版として承認
                3. 運用チームへの共有と教育
                4. 運用設計に基づいた運用手順書の作成

                **保存されたファイル**:
                - 運用設計書: [ファイルパス]
                - 会話ログ: [ファイルパス]

                ご不明な点や追加の質問があれば、いつでもお知らせください。

                [会話ログに最終サマリーを記録して完了]
```

**会話ログへの最終記録**:
```markdown
### [HH:MM] 運用設計セッション完了

**セッション情報**:
- 開始日時: [YYYY-MM-DD HH:MM]
- 終了日時: [YYYY-MM-DD HH:MM]
- 所要時間: [XX]時間

**成果物**:
- 運用設計書: [ファイルパス]
- 会話ログ: [ファイルパス]

**作成内容のサマリー**:
- 作成セクション数: [XX]セクション
- ヒアリング回数: [XX]回
- 検出・修正した矛盾: [XX]件

**主要な運用指標**:
- SLO可用性: [XX.X]%
- SLO レスポンスタイム（P95）: [XXX]ms以下
- SLO エラーレート: [X.X]%以下
- インシデント対応時間: P1=[XX]分、P2=[XX]分
- リリース頻度: [頻度]
- バックアップRPO/RTO: RPO=[XX]時間、RTO=[XX]時間

**次のステップ**:
1. 関係者レビュー
2. 承認プロセス
3. 運用チームへの共有・教育
4. 運用手順書の作成

**セッション完了**
```

